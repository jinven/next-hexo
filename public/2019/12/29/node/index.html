<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="1. 知识点重点：Node 使用事件驱动机制，有一个事件轮询线程负责任务编排(JavaScript回调和非阻塞I&#x2F;O)，和一个专门处理繁重任务的工作线程池(k个工作线程) 运行流程： 1. 完成初始化，处理 &#96;require&#96; 加载的模块和注册事件回调 2. 进入事件循环阶段，通过执行对应回调函数来对客户端请求做出回应。此回调同步执行，完成后可能继续注册新的异步请求，这些异步请求的回调也会在事件轮">
<meta property="og:type" content="article">
<meta property="og:title" content="node">
<meta property="og:url" content="http://yoursite.com/2019/12/29/node/index.html">
<meta property="og:site_name" content="Jinwen">
<meta property="og:description" content="1. 知识点重点：Node 使用事件驱动机制，有一个事件轮询线程负责任务编排(JavaScript回调和非阻塞I&#x2F;O)，和一个专门处理繁重任务的工作线程池(k个工作线程) 运行流程： 1. 完成初始化，处理 &#96;require&#96; 加载的模块和注册事件回调 2. 进入事件循环阶段，通过执行对应回调函数来对客户端请求做出回应。此回调同步执行，完成后可能继续注册新的异步请求，这些异步请求的回调也会在事件轮">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-12-29T08:01:41.000Z">
<meta property="article:modified_time" content="2019-12-30T01:29:45.283Z">
<meta property="article:author" content="Jinwen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2019/12/29/node/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>node | Jinwen</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jinwen</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/29/node/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jinwen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jinwen">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          node
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-29 16:01:41" itemprop="dateCreated datePublished" datetime="2019-12-29T16:01:41+08:00">2019-12-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-30 09:29:45" itemprop="dateModified" datetime="2019-12-30T09:29:45+08:00">2019-12-30</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-知识点"><a href="#1-知识点" class="headerlink" title="1. 知识点"></a>1. 知识点</h1><p>重点：Node 使用事件驱动机制，有一个事件轮询线程负责任务编排(JavaScript回调和非阻塞I/O)，和一个专门处理繁重任务的工作线程池(k个工作线程)</p>
<p>运行流程：</p>
<pre><code>1. 完成初始化，处理 `require` 加载的模块和注册事件回调
2. 进入事件循环阶段，通过执行对应回调函数来对客户端请求做出回应。此回调同步执行，完成后可能继续注册新的异步请求，这些异步请求的回调也会在事件轮询线程中被处理。</code></pre><p>事件轮询线程本身不维护队列，它持有一堆要求操作系统使用诸如 <a href="http://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="noopener">epoll-Linux</a>、<a href="https://developer.apple.com/library/content/documentation/Darwin/Conceptual/FSEvents_ProgGuide/KernelQueues/KernelQueues.html" target="_blank" rel="noopener">kqueue-OSX</a>、event ports-Solaris、<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa365198.aspx" target="_blank" rel="noopener">IOCP-Windows</a>等机制支监听的文件描述符。可能代表一个网络套接字、监听的文件等等。当操作系统确定某个文件的描述符发生变化，事件轮询线程将把它转换成合适的事件，然后触发与该事件对应的回调函数。<br>工作线程池使用一个真实的队列，装着要被处理的任务，一个工作线程从这个队列中取出一个任务开始处理，完成后向事件循环线程中发出一个“至少有一个任务完成了”的消息。</p>
<a id="more"></a>

<p>注意事项：</p>
<pre><code>Node 服务器中，一个连接/任务阻塞了，下一个连接/任务将不会得到执行的机会。
Node 使用 V8 引擎处理 JavaScript，大部分操作很快，但正则表达式、JSON处理例外，检查正则表达式是否安全 [safe-regex](https://github.com/substack/safe-regex)、[rxxr2](http://www.cs.bham.ac.uk/~hxt/research/rxxr2/)，异步JSON [JSONStream](https://www.npmjs.com/package/JSONStream)、[Big-Friendly JSON](https://www.npmjs.com/package/bfj)</code></pre><p>Node 的工作线程池是通过 <a href="http://docs.libuv.org/en/v1.x/threadpool.html" target="_blank" rel="noopener">libuv</a> 来实现的，对外提供了一个通用的任务处理API。<br>Node 使用工作线程池来处理高成本的任务，包括操作系统没有提供非阻塞版本的 I/O 操作，以及一些 CPU 密集型的任务。<br>Node 模块中用到工作线程池的API：</p>
<pre><code>1. DNS：dns.lookup()，dns.lookupService()
2. fs：除fs.FSWatcher()和显式同步调用的API之外，都使用 libuv 的线程池
3. CPU密集型任务：crypto（crypto.pbkdf2()、crypto.scrypt()、crypto.randomBytes()、crypto.randomFill()、crypto.generateKeyPair()）、zlib除显式同步调用的API之外，都使用 libuv 的线程池</code></pre><p>此外，应用程序和模块可以使用 <a href="https://nodejs.org/api/addons.html" target="_blank" rel="noopener">C++插件</a> 向工作线程池提交其它任务。</p>
<p>在一个回调中调用这些 API 时，事件轮询花费少量的额外开销，进入对应 API 与 C++ 桥接通讯的 Node C++ binding 中，向工作线程池提交一个任务。和整个任务的成本相比，这些开销微不足道。<br>事件循环线程总是将这些任务转交给工作线程池。</p>
<ol>
<li>版本支持特性的情况：<a href="https://node.green/" target="_blank" rel="noopener">https://node.green/</a></li>
<li>ES6(ECMAScript 2015)功能分为三个部分：<code>shipping</code>(稳定), <code>staged</code>(不一定稳定), <code>in progress</code>(测试)</li>
<li>开发中的特性：<code>node --v8-options | grep &quot;in progress&quot;</code> (<code>node --v8-options | findstr progress</code>)</li>
<li>特性研发进度：<a href="https://fhinkel.rocks/six-speed/" target="_blank" rel="noopener">https://fhinkel.rocks/six-speed/</a></li>
<li>–harmony：作用是让<code>staged</code>特性起作用，本质等同于<code>--es_staging</code>，如果希望一个安全的环境，应该移除这个运行时的环境标记，直到在<code>V8</code>中以默认形式发布</li>
<li>跟随的V8版本：<code>node -p process.versions.v8</code></li>
<li>调试：<code>node-inspect 1.js</code>、<code>chrome://inspect</code>、<code>visual studio code</code>、<code>visual studio 2017+</code>、<code>JetBrains WebStorm</code>、<code>Gitpod</code>、<code>Eclipse IDE</code>、<code>node debug 1.js</code></li>
<li>压力测试(ApacheBench)：<code>ab -k -c 20 -n 250 &quot;http://localhost:8080/auth?username=matt&amp;password=password&quot;</code></li>
<li>生成刻度文件：<code>node --prof 1.js</code>，会生成 <code>isolate-0xnnnnnnnnnnnn-v8.log</code> 形式的文件</li>
<li>分析刻度：<code>node --prof-process isolate-0xnnnnnnnnnnnn-v8.log &gt; processed.txt</code></li>
<li>火焰图：<a href="https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/" target="_blank" rel="noopener">https://nodejs.org/zh-cn/docs/guides/diagnostics-flamegraph/</a></li>
<li>装到docker：<a href="https://nodejs.org/zh-cn/docs/guides/nodejs-docker-webapp/" target="_blank" rel="noopener">https://nodejs.org/zh-cn/docs/guides/nodejs-docker-webapp/</a></li>
<li>事件轮询：处理非阻塞I/O操作的机制，当有可能的时候，单线程的<code>JavaScript</code>会把操作转移到系统内核中去，多线程的内核在后台处理多种操作，完成一个操作时，通知<code>Node.js</code>将合适的回调函数添加到轮询队列中等待时机执行</li>
<li>事件轮询机制：<code>Node.js</code>启动后，会初始化时间轮询，处理以提供的输入脚本，调用一些异步的API函数，安排任务处理事件，调用<code>process.nextTick()</code>，开始时间循环</li>
<li>事件循环操作顺序：<code>timers</code> -&gt; <code>pending callbacks</code> -&gt; <code>idle, prepare</code> -&gt; <code>poll</code> -&gt; <code>check</code> -&gt; <code>close callbacks</code>，每个阶段都有一个<code>FIFO</code>队列来执行回调</li>
<li>事件阶段概述：<code>定时器</code>-执行已安排的<code>setTimeout</code>和<code>setInterval</code>回调函数，<code>待定回调</code>-执行延迟到下一循环迭代的<code>I/O</code>回调，<code>idle,prepare</code>-仅系统内部使用，<code>轮询</code>-检索新的<code>I/O</code>事件-执行<code>I/O</code>相关的回调-其余情况将在此处阻塞，<code>检测</code>-<code>setImmediate</code>回调函数在这里执行，<code>关闭的回调函数</code>-一些准备关闭的回调函数(如：<code>socket.on(&#39;close&#39;, ...)</code>)</li>
<li>setImmediate和setTimeout：<code>setImmediate()</code>-设计为在当前轮询阶段完成后执行脚本，<code>setTimeout()</code>-计划在毫秒的最小阈值经过后运行的脚本</li>
<li>process.nextTick和setImmediate：<code>process.nextTick()</code>-在同一阶段立即执行，<code>setImmediate()</code>-在以下迭代或tick上触发事件循环，建议所有情况下都使用 <code>setImmediate()</code></li>
<li>使用 process.nextTick() 原因：1-允许处理错误、清理不需要的资源、在事件循环继续之前重试请求；2-有时在调用堆栈已解除但在事件循环继续之前，必须允许回调运行</li>
<li>Node中，有两种类型的线程：1-事件循环线程（主循环、主线程）；2-工作线程池里的 <code>k</code> 个工作线程（线程池）</li>
<li>阻塞：一个线程执行一个回调函数（事件轮询线程）或者任务（工作线程）需要耗费很长时间</li>
</ol>
<h1 id="2-内置变量"><a href="#2-内置变量" class="headerlink" title="2. 内置变量"></a>2. 内置变量</h1><ol>
<li>看起来是全局变量，但不是全局变量</li>
</ol>
<ul>
<li><code>__filename</code> 当前文件路径</li>
<li><code>__dirname</code> 当前目录路径</li>
<li><code>exports</code> module.exports的引用，导出内存模块</li>
<li><code>module</code> node定义的一个构造函数</li>
</ul>
<ol start="2">
<li>全局变量</li>
</ol>
<ul>
<li><code>console</code> 用于提供控制台标准输出，它是由 Internet Explorer 的 JScript 引擎提供的调试工具，后来逐渐成为浏览器的实施标准</li>
<li><code>process</code> 流程对象，描述当前Node.js 进程状态的对象，提供了一个与操作系统的简单接口</li>
<li><code>global</code> 在浏览器中，顶级范围是全局范围。这意味着浏览器内var something将定义一个新的全局变量。在Node.js中，这是不同的。顶级范围不是全局范围； var somethingNode.js模块内部将是该模块的本地模块</li>
<li><code>TextDecoder</code></li>
<li><code>TextEncoder</code></li>
<li><code>URL</code></li>
<li><code>URLSearchParams</code></li>
<li><code>WebAssembly</code></li>
</ul>
<h1 id="3-内置方法-函数"><a href="#3-内置方法-函数" class="headerlink" title="3. 内置方法/函数"></a>3. 内置方法/函数</h1><h2 id="1-setTimeout、clearTimeout"><a href="#1-setTimeout、clearTimeout" class="headerlink" title="1. setTimeout、clearTimeout"></a>1. setTimeout、clearTimeout</h2><pre><code>描述：一段时间之后执行指定函数
第一个参数：可执行函数
第二个参数：延时时间
第三个参数：函数的参数
返回结果：Timeout 对象，可用来取消定时

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">arg</span>)</span>&#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`arg was =&gt; <span class="subst">$&#123;arg&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> timeout = setTimeout(foo, <span class="number">1000</span>, <span class="string">'funky'</span>);</span><br><span class="line"><span class="comment">// clearTimeout(timeout);</span></span><br><span class="line"><span class="comment">// timeout.unref();</span></span><br><span class="line"><span class="comment">// timeout.ref();</span></span><br></pre></td></tr></table></figure></code></pre><h2 id="2-setImmediate、clearImmediate"><a href="#2-setImmediate、clearImmediate" class="headerlink" title="2. setImmediate、clearImmediate"></a>2. setImmediate、clearImmediate</h2><pre><code>描述：在此之后立即执行指定函数
第一个参数：可执行函数
返回结果：Immediate 对象，可用来取消定时

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'before immediate'</span>);</span><br><span class="line"><span class="keyword">var</span> immediate = setImmediate( <span class="function">(<span class="params">arg</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`executing immediate: <span class="subst">$&#123;arg&#125;</span>`</span>);</span><br><span class="line">&#125;, <span class="string">'so immediate'</span>);</span><br><span class="line"><span class="comment">// clearImmediate(immediate);</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'after immediate'</span>);</span><br></pre></td></tr></table></figure></code></pre><h2 id="3-setInterval、clearInterval"><a href="#3-setInterval、clearInterval" class="headerlink" title="3. setInterval、clearInterval"></a>3. setInterval、clearInterval</h2><pre><code>描述：每一段时间后执行指定函数
第一个参数：可执行函数
第二个参数：延时时间
第三个参数：函数的参数
返回结果：Interval 对象，可用来取消定时

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">intervalFunc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Cant stop me now!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> interval = setInterval(intervalFunc, <span class="number">1500</span>);</span><br><span class="line"><span class="comment">// clearInterval(interval);</span></span><br><span class="line"><span class="comment">// interval.unref();</span></span><br><span class="line"><span class="comment">// interval.ref();</span></span><br></pre></td></tr></table></figure></code></pre><h2 id="4-Buffer"><a href="#4-Buffer" class="headerlink" title="4. Buffer"></a>4. Buffer</h2><p>在引入TypedArray之前，JavaScript语言没有用于读取或处理二进制数据流的机制。 Buffer类是作为Node.js API的一部分引入的，以允许与TCP流，文件系统操作和其他上下文中的八位位组流进行交互。<br>有了TypedArray，Buffer类以更优化的方式和适用于Node.js的方式实现Uint8Array API。<br>Buffer类的实例类似于从0到255的整数数组（其他整数通过＆255操作强制到此范围），但对应于V8堆之外的固定大小的原始内存分配。 缓冲区的大小是在创建时创建的，无法更改。<br>Buffer类在全局范围内，因此不太可能需要使用require(‘buffer’)。Buffer。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creates a zero-filled Buffer of length 10.</span></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.alloc(<span class="number">10</span>);</span><br><span class="line"><span class="comment">// Creates a Buffer of length 10, filled with 0x1.</span></span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.alloc(<span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// Creates an uninitialized buffer of length 10.</span></span><br><span class="line"><span class="comment">// This is faster than calling Buffer.alloc() but the returned</span></span><br><span class="line"><span class="comment">// Buffer instance might contain old data that needs to be</span></span><br><span class="line"><span class="comment">// overwritten using either fill() or write().</span></span><br><span class="line"><span class="keyword">const</span> buf3 = Buffer.allocUnsafe(<span class="number">10</span>);</span><br><span class="line"><span class="comment">// Creates a Buffer containing [0x1, 0x2, 0x3].</span></span><br><span class="line"><span class="keyword">const</span> buf4 = Buffer.from([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">// Creates a Buffer containing UTF-8 bytes [0x74, 0xc3, 0xa9, 0x73, 0x74].</span></span><br><span class="line"><span class="keyword">const</span> buf5 = Buffer.from(<span class="string">'tést'</span>);</span><br><span class="line"><span class="comment">// Creates a Buffer containing Latin-1 bytes [0x74, 0xe9, 0x73, 0x74].</span></span><br><span class="line"><span class="keyword">const</span> buf6 = Buffer.from(<span class="string">'tést'</span>, <span class="string">'latin1'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'hello world'</span>, <span class="string">'ascii'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(buf.toString(<span class="string">'hex'</span>));</span><br><span class="line"><span class="comment">// Prints: 68656c6c6f20776f726c64</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.toString(<span class="string">'base64'</span>));</span><br><span class="line"><span class="comment">// Prints: aGVsbG8gd29ybGQ=</span></span><br><span class="line"><span class="built_in">console</span>.log(Buffer.from(<span class="string">'fhqwhgads'</span>, <span class="string">'ascii'</span>));</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 66 68 71 77 68 67 61 64 73&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(Buffer.from(<span class="string">'fhqwhgads'</span>, <span class="string">'utf16le'</span>));</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 66 00 68 00 71 00 77 00 68 00 67 00 61 00 64 00 73 00&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="built_in">Uint16Array</span>(<span class="number">2</span>);</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">5000</span>;</span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">4000</span>;</span><br><span class="line"><span class="comment">// Copies the contents of `arr`.</span></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.from(arr);</span><br><span class="line"><span class="comment">// Shares memory with `arr`.</span></span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from(arr.buffer);</span><br><span class="line"><span class="built_in">console</span>.log(buf1);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 88 a0&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 88 13 a0 0f&gt;</span></span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">6000</span>;</span><br><span class="line"><span class="built_in">console</span>.log(buf1);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 88 a0&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 88 13 70 17&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="built_in">Uint16Array</span>(<span class="number">20</span>);</span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(arr.buffer, <span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.length);</span><br><span class="line"><span class="comment">// Prints: 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> b <span class="keyword">of</span> buf) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Prints:</span></span><br><span class="line"><span class="comment">//   1</span></span><br><span class="line"><span class="comment">//   2</span></span><br><span class="line"><span class="comment">//   3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Creates a new Buffer containing the UTF-8 bytes of the string 'buffer'.</span></span><br><span class="line"><span class="keyword">const</span> buf = <span class="keyword">new</span> Buffer([<span class="number">0x62</span>, <span class="number">0x75</span>, <span class="number">0x66</span>, <span class="number">0x66</span>, <span class="number">0x65</span>, <span class="number">0x72</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="built_in">Uint16Array</span>(<span class="number">2</span>);</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">5000</span>;</span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">4000</span>;</span><br><span class="line"><span class="comment">// Shares memory with `arr`.</span></span><br><span class="line"><span class="keyword">const</span> buf = <span class="keyword">new</span> Buffer(arr.buffer);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 88 13 a0 0f&gt;</span></span><br><span class="line"><span class="comment">// Changing the original Uint16Array changes the Buffer also.</span></span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">6000</span>;</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 88 13 70 17&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = <span class="keyword">new</span> Buffer(<span class="string">'buffer'</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = <span class="keyword">new</span> Buffer(buf1);</span><br><span class="line">buf1[<span class="number">0</span>] = <span class="number">0x61</span>;</span><br><span class="line"><span class="built_in">console</span>.log(buf1.toString());</span><br><span class="line"><span class="comment">// Prints: auffer</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString());</span><br><span class="line"><span class="comment">// Prints: buffer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = <span class="keyword">new</span> Buffer(<span class="number">10</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = <span class="keyword">new</span> Buffer(<span class="string">'this is a tést'</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = <span class="keyword">new</span> Buffer(<span class="string">'7468697320697320612074c3a97374'</span>, <span class="string">'hex'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf1.toString());</span><br><span class="line"><span class="comment">// Prints: this is a tést</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString());</span><br><span class="line"><span class="comment">// Prints: this is a tést</span></span><br><span class="line"><span class="built_in">console</span>.log(buf1.toString(<span class="string">'ascii'</span>));</span><br><span class="line"><span class="comment">// Prints: this is a tC)st</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.alloc(<span class="number">5</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 00 00 00 00 00&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.alloc(<span class="number">5</span>, <span class="string">'a'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 61 61 61 61 61&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.alloc(<span class="number">11</span>, <span class="string">'aGVsbG8gd29ybGQ='</span>, <span class="string">'base64'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 68 65 6c 6c 6f 20 77 6f 72 6c 64&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">10</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints (contents may vary): &lt;Buffer a0 8b 28 3f 01 00 00 00 50 32&gt;</span></span><br><span class="line">buf.fill(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Need to keep around a few small chunks of memory.</span></span><br><span class="line"><span class="keyword">const</span> store = [];</span><br><span class="line">socket.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> data;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">null</span> !== (data = readable.read())) &#123;</span><br><span class="line">    <span class="comment">// Allocate for retained data.</span></span><br><span class="line">    <span class="keyword">const</span> sb = Buffer.allocUnsafeSlow(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// Copy the data into the new allocation.</span></span><br><span class="line">    data.copy(sb, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    store.push(sb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> str = <span class="string">'\u00bd + \u00bc = \u00be'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;str&#125;</span>: <span class="subst">$&#123;str.length&#125;</span> characters, `</span> + <span class="string">`<span class="subst">$&#123;Buffer.byteLength(str, <span class="string">'utf8'</span>)&#125;</span> bytes`</span>);</span><br><span class="line"><span class="comment">// Prints: ½ + ¼ = ¾: 9 characters, 12 bytes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.from(<span class="string">'1234'</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from(<span class="string">'0123'</span>);</span><br><span class="line"><span class="keyword">const</span> arr = [buf1, buf2];</span><br><span class="line"><span class="built_in">console</span>.log(arr.sort(Buffer.compare));</span><br><span class="line"><span class="comment">// Prints: [ &lt;Buffer 30 31 32 33&gt;, &lt;Buffer 31 32 33 34&gt; ]</span></span><br><span class="line"><span class="comment">// (This result is equal to: [buf2, buf1].)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a single `Buffer` from a list of three `Buffer` instances.</span></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.alloc(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.alloc(<span class="number">14</span>);</span><br><span class="line"><span class="keyword">const</span> buf3 = Buffer.alloc(<span class="number">18</span>);</span><br><span class="line"><span class="keyword">const</span> totalLength = buf1.length + buf2.length + buf3.length;</span><br><span class="line"><span class="built_in">console</span>.log(totalLength);</span><br><span class="line"><span class="comment">// Prints: 42</span></span><br><span class="line"><span class="keyword">const</span> bufA = Buffer.concat([buf1, buf2, buf3], totalLength);</span><br><span class="line"><span class="built_in">console</span>.log(bufA);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 00 00 00 00 ...&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(bufA.length);</span><br><span class="line"><span class="comment">// Prints: 42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Creates a new Buffer containing UTF-8 bytes of the string 'buffer'.</span></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">0x62</span>, <span class="number">0x75</span>, <span class="number">0x66</span>, <span class="number">0x66</span>, <span class="number">0x65</span>, <span class="number">0x72</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="built_in">Uint16Array</span>(<span class="number">2</span>);</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">5000</span>;</span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">4000</span>;</span><br><span class="line"><span class="comment">// Shares memory with `arr`.</span></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(arr.buffer);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 88 13 a0 0f&gt;</span></span><br><span class="line"><span class="comment">// Changing the original Uint16Array changes the Buffer also.</span></span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">6000</span>;</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 88 13 70 17&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(ab, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.length);</span><br><span class="line"><span class="comment">// Prints: 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.from(<span class="string">'buffer'</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from(buf1);</span><br><span class="line">buf1[<span class="number">0</span>] = <span class="number">0x61</span>;</span><br><span class="line"><span class="built_in">console</span>.log(buf1.toString());</span><br><span class="line"><span class="comment">// Prints: auffer</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString());</span><br><span class="line"><span class="comment">// Prints: buffer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">'this is a test'</span>));</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 74 68 69 73 20 69 73 20 61 20 74 65 73 74&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">  [<span class="built_in">Symbol</span>.toPrimitive]() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'this is a test'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="keyword">new</span> Foo(), <span class="string">'utf8'</span>);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 74 68 69 73 20 69 73 20 61 20 74 65 73 74&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.from(<span class="string">'this is a tést'</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from(<span class="string">'7468697320697320612074c3a97374'</span>, <span class="string">'hex'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf1.toString());</span><br><span class="line"><span class="comment">// Prints: this is a tést</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString());</span><br><span class="line"><span class="comment">// Prints: this is a tést</span></span><br><span class="line"><span class="built_in">console</span>.log(buf1.toString(<span class="string">'ascii'</span>));</span><br><span class="line"><span class="comment">// Prints: this is a tC)st</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(Buffer.isEncoding(<span class="string">'utf-8'</span>));</span><br><span class="line"><span class="comment">// Prints: true</span></span><br><span class="line"><span class="built_in">console</span>.log(Buffer.isEncoding(<span class="string">'hex'</span>));</span><br><span class="line"><span class="comment">// Prints: true</span></span><br><span class="line"><span class="built_in">console</span>.log(Buffer.isEncoding(<span class="string">'utf/8'</span>));</span><br><span class="line"><span class="comment">// Prints: false</span></span><br><span class="line"><span class="built_in">console</span>.log(Buffer.isEncoding(<span class="string">''</span>));</span><br><span class="line"><span class="comment">// Prints: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Copy an ASCII string into a `Buffer` one byte at a time.</span></span><br><span class="line"><span class="keyword">const</span> str = <span class="string">'Node.js'</span>;</span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(str.length);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.length; i++) &#123;</span><br><span class="line">  buf[i] = str.charCodeAt(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(buf.toString(<span class="string">'ascii'</span>));</span><br><span class="line"><span class="comment">// Prints: Node.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arrayBuffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">const</span> buffer = Buffer.from(arrayBuffer);</span><br><span class="line"><span class="built_in">console</span>.log(buffer.buffer === arrayBuffer);</span><br><span class="line"><span class="comment">// Prints: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a buffer smaller than `Buffer.poolSize`.</span></span><br><span class="line"><span class="keyword">const</span> nodeBuffer = <span class="keyword">new</span> Buffer.from([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]);</span><br><span class="line"><span class="comment">// When casting the Node.js Buffer to an Int8 TypedArray remember to use the</span></span><br><span class="line"><span class="comment">// byteOffset.</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Int8Array</span>(nodeBuffer.buffer, nodeBuffer.byteOffset, nodeBuffer.length);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.from(<span class="string">'ABC'</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from(<span class="string">'BCD'</span>);</span><br><span class="line"><span class="keyword">const</span> buf3 = Buffer.from(<span class="string">'ABCD'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf1.compare(buf1));</span><br><span class="line"><span class="comment">// Prints: 0</span></span><br><span class="line"><span class="built_in">console</span>.log(buf1.compare(buf2));</span><br><span class="line"><span class="comment">// Prints: -1</span></span><br><span class="line"><span class="built_in">console</span>.log(buf1.compare(buf3));</span><br><span class="line"><span class="comment">// Prints: -1</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2.compare(buf1));</span><br><span class="line"><span class="comment">// Prints: 1</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2.compare(buf3));</span><br><span class="line"><span class="comment">// Prints: 1</span></span><br><span class="line"><span class="built_in">console</span>.log([buf1, buf2, buf3].sort(Buffer.compare));</span><br><span class="line"><span class="comment">// Prints: [ &lt;Buffer 41 42 43&gt;, &lt;Buffer 41 42 43 44&gt;, &lt;Buffer 42 43 44&gt; ]</span></span><br><span class="line"><span class="comment">// (This result is equal to: [buf1, buf3, buf2].)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.from([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]);</span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from([<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf1.compare(buf2, <span class="number">5</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line"><span class="comment">// Prints: 0</span></span><br><span class="line"><span class="built_in">console</span>.log(buf1.compare(buf2, <span class="number">0</span>, <span class="number">6</span>, <span class="number">4</span>));</span><br><span class="line"><span class="comment">// Prints: -1</span></span><br><span class="line"><span class="built_in">console</span>.log(buf1.compare(buf2, <span class="number">5</span>, <span class="number">6</span>, <span class="number">5</span>));</span><br><span class="line"><span class="comment">// Prints: 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create two `Buffer` instances.</span></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.allocUnsafe(<span class="number">26</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.allocUnsafe(<span class="number">26</span>).fill(<span class="string">'!'</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// 97 is the decimal ASCII value for 'a'.</span></span><br><span class="line">  buf1[i] = i + <span class="number">97</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Copy `buf1` bytes 16 through 19 into `buf2` starting at byte 8 of `buf2`.</span></span><br><span class="line">buf1.copy(buf2, <span class="number">8</span>, <span class="number">16</span>, <span class="number">20</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString(<span class="string">'ascii'</span>, <span class="number">0</span>, <span class="number">25</span>));</span><br><span class="line"><span class="comment">// Prints: !!!!!!!!qrst!!!!!!!!!!!!!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a `Buffer` and copy data from one region to an overlapping region</span></span><br><span class="line"><span class="comment">// within the same `Buffer`.</span></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">26</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// 97 is the decimal ASCII value for 'a'.</span></span><br><span class="line">  buf[i] = i + <span class="number">97</span>;</span><br><span class="line">&#125;</span><br><span class="line">buf.copy(buf, <span class="number">0</span>, <span class="number">4</span>, <span class="number">10</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.toString());</span><br><span class="line"><span class="comment">// Prints: efghijghijklmnopqrstuvwxyz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Log the entire contents of a `Buffer`.</span></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'buffer'</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> pair <span class="keyword">of</span> buf.entries()) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(pair);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Prints:</span></span><br><span class="line"><span class="comment">//   [0, 98]</span></span><br><span class="line"><span class="comment">//   [1, 117]</span></span><br><span class="line"><span class="comment">//   [2, 102]</span></span><br><span class="line"><span class="comment">//   [3, 102]</span></span><br><span class="line"><span class="comment">//   [4, 101]</span></span><br><span class="line"><span class="comment">//   [5, 114]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.from(<span class="string">'ABC'</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from(<span class="string">'414243'</span>, <span class="string">'hex'</span>);</span><br><span class="line"><span class="keyword">const</span> buf3 = Buffer.from(<span class="string">'ABCD'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf1.equals(buf2));</span><br><span class="line"><span class="comment">// Prints: true</span></span><br><span class="line"><span class="built_in">console</span>.log(buf1.equals(buf3));</span><br><span class="line"><span class="comment">// Prints: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Fill a `Buffer` with the ASCII character 'h'.</span></span><br><span class="line"><span class="keyword">const</span> b = Buffer.allocUnsafe(<span class="number">50</span>).fill(<span class="string">'h'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(b.toString());</span><br><span class="line"><span class="comment">// Prints: hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Fill a `Buffer` with a two-byte character.</span></span><br><span class="line"><span class="built_in">console</span>.log(Buffer.allocUnsafe(<span class="number">3</span>).fill(<span class="string">'\u0222'</span>));</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer c8 a2 c8&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">5</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.fill(<span class="string">'a'</span>));</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 61 61 61 61 61&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.fill(<span class="string">'aazz'</span>, <span class="string">'hex'</span>));</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer aa aa aa aa aa&gt;</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.fill(<span class="string">'zz'</span>, <span class="string">'hex'</span>));</span><br><span class="line"><span class="comment">// Throws an exception.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'this is a buffer'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.includes(<span class="string">'this'</span>));</span><br><span class="line"><span class="comment">// Prints: true</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.includes(<span class="string">'is'</span>));</span><br><span class="line"><span class="comment">// Prints: true</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.includes(Buffer.from(<span class="string">'a buffer'</span>)));</span><br><span class="line"><span class="comment">// Prints: true</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.includes(<span class="number">97</span>));</span><br><span class="line"><span class="comment">// Prints: true (97 is the decimal ASCII value for 'a')</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.includes(Buffer.from(<span class="string">'a buffer example'</span>)));</span><br><span class="line"><span class="comment">// Prints: false</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.includes(Buffer.from(<span class="string">'a buffer example'</span>).slice(<span class="number">0</span>, <span class="number">8</span>)));</span><br><span class="line"><span class="comment">// Prints: true</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.includes(<span class="string">'this'</span>, <span class="number">4</span>));</span><br><span class="line"><span class="comment">// Prints: false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'this is a buffer'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.indexOf(<span class="string">'this'</span>));</span><br><span class="line"><span class="comment">// Prints: 0</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.indexOf(<span class="string">'is'</span>));</span><br><span class="line"><span class="comment">// Prints: 2</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.indexOf(Buffer.from(<span class="string">'a buffer'</span>)));</span><br><span class="line"><span class="comment">// Prints: 8</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.indexOf(<span class="number">97</span>));</span><br><span class="line"><span class="comment">// Prints: 8 (97 is the decimal ASCII value for 'a')</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.indexOf(Buffer.from(<span class="string">'a buffer example'</span>)));</span><br><span class="line"><span class="comment">// Prints: -1</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.indexOf(Buffer.from(<span class="string">'a buffer example'</span>).slice(<span class="number">0</span>, <span class="number">8</span>)));</span><br><span class="line"><span class="comment">// Prints: 8</span></span><br><span class="line"><span class="keyword">const</span> utf16Buffer = Buffer.from(<span class="string">'\u039a\u0391\u03a3\u03a3\u0395'</span>, <span class="string">'utf16le'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(utf16Buffer.indexOf(<span class="string">'\u03a3'</span>, <span class="number">0</span>, <span class="string">'utf16le'</span>));</span><br><span class="line"><span class="comment">// Prints: 4</span></span><br><span class="line"><span class="built_in">console</span>.log(utf16Buffer.indexOf(<span class="string">'\u03a3'</span>, <span class="number">-4</span>, <span class="string">'utf16le'</span>));</span><br><span class="line"><span class="comment">// Prints: 6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = Buffer.from(<span class="string">'abcdef'</span>);</span><br><span class="line"><span class="comment">// Passing a value that's a number, but not a valid byte.</span></span><br><span class="line"><span class="comment">// Prints: 2, equivalent to searching for 99 or 'c'.</span></span><br><span class="line"><span class="built_in">console</span>.log(b.indexOf(<span class="number">99.9</span>));</span><br><span class="line"><span class="built_in">console</span>.log(b.indexOf(<span class="number">256</span> + <span class="number">99</span>));</span><br><span class="line"><span class="comment">// Passing a byteOffset that coerces to NaN or 0.</span></span><br><span class="line"><span class="comment">// Prints: 1, searching the whole buffer.</span></span><br><span class="line"><span class="built_in">console</span>.log(b.indexOf(<span class="string">'b'</span>, <span class="literal">undefined</span>));</span><br><span class="line"><span class="built_in">console</span>.log(b.indexOf(<span class="string">'b'</span>, &#123;&#125;));</span><br><span class="line"><span class="built_in">console</span>.log(b.indexOf(<span class="string">'b'</span>, <span class="literal">null</span>));</span><br><span class="line"><span class="built_in">console</span>.log(b.indexOf(<span class="string">'b'</span>, []));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'buffer'</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> buf.keys()) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Prints:</span></span><br><span class="line"><span class="comment">//   0</span></span><br><span class="line"><span class="comment">//   1</span></span><br><span class="line"><span class="comment">//   2</span></span><br><span class="line"><span class="comment">//   3</span></span><br><span class="line"><span class="comment">//   4</span></span><br><span class="line"><span class="comment">//   5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'this buffer is a buffer'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.lastIndexOf(<span class="string">'this'</span>));</span><br><span class="line"><span class="comment">// Prints: 0</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.lastIndexOf(<span class="string">'buffer'</span>));</span><br><span class="line"><span class="comment">// Prints: 17</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.lastIndexOf(Buffer.from(<span class="string">'buffer'</span>)));</span><br><span class="line"><span class="comment">// Prints: 17</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.lastIndexOf(<span class="number">97</span>));</span><br><span class="line"><span class="comment">// Prints: 15 (97 is the decimal ASCII value for 'a')</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.lastIndexOf(Buffer.from(<span class="string">'yolo'</span>)));</span><br><span class="line"><span class="comment">// Prints: -1</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.lastIndexOf(<span class="string">'buffer'</span>, <span class="number">5</span>));</span><br><span class="line"><span class="comment">// Prints: 5</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.lastIndexOf(<span class="string">'buffer'</span>, <span class="number">4</span>));</span><br><span class="line"><span class="comment">// Prints: -1</span></span><br><span class="line"><span class="keyword">const</span> utf16Buffer = Buffer.from(<span class="string">'\u039a\u0391\u03a3\u03a3\u0395'</span>, <span class="string">'utf16le'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(utf16Buffer.lastIndexOf(<span class="string">'\u03a3'</span>, <span class="literal">undefined</span>, <span class="string">'utf16le'</span>));</span><br><span class="line"><span class="comment">// Prints: 6</span></span><br><span class="line"><span class="built_in">console</span>.log(utf16Buffer.lastIndexOf(<span class="string">'\u03a3'</span>, <span class="number">-5</span>, <span class="string">'utf16le'</span>));</span><br><span class="line"><span class="comment">// Prints: 4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = Buffer.from(<span class="string">'abcdef'</span>);</span><br><span class="line"><span class="comment">// Passing a value that's a number, but not a valid byte.</span></span><br><span class="line"><span class="comment">// Prints: 2, equivalent to searching for 99 or 'c'.</span></span><br><span class="line"><span class="built_in">console</span>.log(b.lastIndexOf(<span class="number">99.9</span>));</span><br><span class="line"><span class="built_in">console</span>.log(b.lastIndexOf(<span class="number">256</span> + <span class="number">99</span>));</span><br><span class="line"><span class="comment">// Passing a byteOffset that coerces to NaN.</span></span><br><span class="line"><span class="comment">// Prints: 1, searching the whole buffer.</span></span><br><span class="line"><span class="built_in">console</span>.log(b.lastIndexOf(<span class="string">'b'</span>, <span class="literal">undefined</span>));</span><br><span class="line"><span class="built_in">console</span>.log(b.lastIndexOf(<span class="string">'b'</span>, &#123;&#125;));</span><br><span class="line"><span class="comment">// Passing a byteOffset that coerces to 0.</span></span><br><span class="line"><span class="comment">// Prints: -1, equivalent to passing 0.</span></span><br><span class="line"><span class="built_in">console</span>.log(b.lastIndexOf(<span class="string">'b'</span>, <span class="literal">null</span>));</span><br><span class="line"><span class="built_in">console</span>.log(b.lastIndexOf(<span class="string">'b'</span>, []));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a `Buffer` and write a shorter ASCII string to it.</span></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.alloc(<span class="number">1234</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.length);</span><br><span class="line"><span class="comment">// Prints: 1234</span></span><br><span class="line">buf.write(<span class="string">'some string'</span>, <span class="number">0</span>, <span class="string">'ascii'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.length);</span><br><span class="line"><span class="comment">// Prints: 1234</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = Buffer.allocUnsafe(<span class="number">10</span>);</span><br><span class="line">buf.write(<span class="string">'abcdefghj'</span>, <span class="number">0</span>, <span class="string">'ascii'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.length);</span><br><span class="line"><span class="comment">// Prints: 10</span></span><br><span class="line">buf = buf.slice(<span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.length);</span><br><span class="line"><span class="comment">// Prints: 5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readBigUInt64BE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 4294967295n</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readBigUInt64LE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 18446744069414584320n</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readDoubleBE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 8.20788039913184e-304</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readDoubleLE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 5.447603722011605e-270</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readDoubleLE(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readFloatBE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 2.387939260590663e-38</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readFloatLE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 1.539989614439558e-36</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readFloatLE(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">-1</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readInt8(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: -1</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readInt8(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// Prints: 5</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readInt8(<span class="number">2</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">0</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readInt16BE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 5</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readInt16LE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 1280</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readInt16LE(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readInt32BE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 5</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readInt32LE(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 83886080</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readInt32LE(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0x78</span>, <span class="number">0x90</span>, <span class="number">0xab</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readIntLE(<span class="number">0</span>, <span class="number">6</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: -546f87a9cbee</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readIntBE(<span class="number">0</span>, <span class="number">6</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: 1234567890ab</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readIntBE(<span class="number">1</span>, <span class="number">6</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readIntBE(<span class="number">1</span>, <span class="number">0</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">1</span>, <span class="number">-2</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt8(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// Prints: 1</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt8(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// Prints: 254</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt8(<span class="number">2</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt16BE(<span class="number">0</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: 1234</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt16LE(<span class="number">0</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: 3412</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt16BE(<span class="number">1</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: 3456</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt16LE(<span class="number">1</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: 5634</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt16LE(<span class="number">2</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0x78</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt32BE(<span class="number">0</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: 12345678</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt32LE(<span class="number">0</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: 78563412</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUInt32LE(<span class="number">1</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0x78</span>, <span class="number">0x90</span>, <span class="number">0xab</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf.readUIntBE(<span class="number">0</span>, <span class="number">6</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: 1234567890ab</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUIntLE(<span class="number">0</span>, <span class="number">6</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Prints: ab9078563412</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.readUIntBE(<span class="number">1</span>, <span class="number">6</span>).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// Throws ERR_OUT_OF_RANGE.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a `Buffer` with the ASCII alphabet, take a slice, and modify one byte</span></span><br><span class="line"><span class="comment">// from the original `Buffer`.</span></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.allocUnsafe(<span class="number">26</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// 97 is the decimal ASCII value for 'a'.</span></span><br><span class="line">  buf1[i] = i + <span class="number">97</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> buf2 = buf1.subarray(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString(<span class="string">'ascii'</span>, <span class="number">0</span>, buf2.length));</span><br><span class="line"><span class="comment">// Prints: abc</span></span><br><span class="line">buf1[<span class="number">0</span>] = <span class="number">33</span>;</span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString(<span class="string">'ascii'</span>, <span class="number">0</span>, buf2.length));</span><br><span class="line"><span class="comment">// Prints: !bc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'buffer'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf.subarray(<span class="number">-6</span>, <span class="number">-1</span>).toString());</span><br><span class="line"><span class="comment">// Prints: buffe</span></span><br><span class="line"><span class="comment">// (Equivalent to buf.subarray(0, 5).)</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.subarray(<span class="number">-6</span>, <span class="number">-2</span>).toString());</span><br><span class="line"><span class="comment">// Prints: buff</span></span><br><span class="line"><span class="comment">// (Equivalent to buf.subarray(0, 4).)</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.subarray(<span class="number">-5</span>, <span class="number">-2</span>).toString());</span><br><span class="line"><span class="comment">// Prints: uff</span></span><br><span class="line"><span class="comment">// (Equivalent to buf.subarray(1, 4).)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'buffer'</span>);</span><br><span class="line"><span class="keyword">const</span> copiedBuf = <span class="built_in">Uint8Array</span>.prototype.slice.call(buf);</span><br><span class="line">copiedBuf[<span class="number">0</span>]++;</span><br><span class="line"><span class="built_in">console</span>.log(copiedBuf.toString());</span><br><span class="line"><span class="comment">// Prints: cuffer</span></span><br><span class="line"><span class="built_in">console</span>.log(buf.toString());</span><br><span class="line"><span class="comment">// Prints: buffer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.from([<span class="number">0x1</span>, <span class="number">0x2</span>, <span class="number">0x3</span>, <span class="number">0x4</span>, <span class="number">0x5</span>, <span class="number">0x6</span>, <span class="number">0x7</span>, <span class="number">0x8</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf1);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 01 02 03 04 05 06 07 08&gt;</span></span><br><span class="line">buf1.swap16();</span><br><span class="line"><span class="built_in">console</span>.log(buf1);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 02 01 04 03 06 05 08 07&gt;</span></span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from([<span class="number">0x1</span>, <span class="number">0x2</span>, <span class="number">0x3</span>]);</span><br><span class="line">buf2.swap16();</span><br><span class="line"><span class="comment">// Throws ERR_INVALID_BUFFER_SIZE.</span></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'This is little-endian UTF-16'</span>, <span class="string">'utf16le'</span>);</span><br><span class="line">buf.swap16(); <span class="comment">// Convert to big-endian UTF-16 text.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.from([<span class="number">0x1</span>, <span class="number">0x2</span>, <span class="number">0x3</span>, <span class="number">0x4</span>, <span class="number">0x5</span>, <span class="number">0x6</span>, <span class="number">0x7</span>, <span class="number">0x8</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(buf1);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 01 02 03 04 05 06 07 08&gt;</span></span><br><span class="line">buf1.swap64();</span><br><span class="line"><span class="built_in">console</span>.log(buf1);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 08 07 06 05 04 03 02 01&gt;</span></span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from([<span class="number">0x1</span>, <span class="number">0x2</span>, <span class="number">0x3</span>]);</span><br><span class="line">buf2.swap64();</span><br><span class="line"><span class="comment">// Throws ERR_INVALID_BUFFER_SIZE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from([<span class="number">0x1</span>, <span class="number">0x2</span>, <span class="number">0x3</span>, <span class="number">0x4</span>, <span class="number">0x5</span>]);</span><br><span class="line"><span class="keyword">const</span> json = <span class="built_in">JSON</span>.stringify(buf);</span><br><span class="line"><span class="built_in">console</span>.log(json);</span><br><span class="line"><span class="comment">// Prints: &#123;"type":"Buffer","data":[1,2,3,4,5]&#125;</span></span><br><span class="line"><span class="keyword">const</span> copy = <span class="built_in">JSON</span>.parse(json, (key, value) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> value &amp;&amp; value.type === <span class="string">'Buffer'</span> ?</span><br><span class="line">    Buffer.from(value.data) :</span><br><span class="line">    value;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(copy);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 01 02 03 04 05&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.allocUnsafe(<span class="number">26</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</span><br><span class="line">  <span class="comment">// 97 is the decimal ASCII value for 'a'.</span></span><br><span class="line">  buf1[i] = i + <span class="number">97</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(buf1.toString(<span class="string">'ascii'</span>));</span><br><span class="line"><span class="comment">// Prints: abcdefghijklmnopqrstuvwxyz</span></span><br><span class="line"><span class="built_in">console</span>.log(buf1.toString(<span class="string">'ascii'</span>, <span class="number">0</span>, <span class="number">5</span>));</span><br><span class="line"><span class="comment">// Prints: abcde</span></span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from(<span class="string">'tést'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString(<span class="string">'hex'</span>));</span><br><span class="line"><span class="comment">// Prints: 74c3a97374</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString(<span class="string">'utf8'</span>, <span class="number">0</span>, <span class="number">3</span>));</span><br><span class="line"><span class="comment">// Prints: té</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2.toString(<span class="literal">undefined</span>, <span class="number">0</span>, <span class="number">3</span>));</span><br><span class="line"><span class="comment">// Prints: té</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.from(<span class="string">'buffer'</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> value <span class="keyword">of</span> buf.values()) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Prints:</span></span><br><span class="line"><span class="comment">//   98</span></span><br><span class="line"><span class="comment">//   117</span></span><br><span class="line"><span class="comment">//   102</span></span><br><span class="line"><span class="comment">//   102</span></span><br><span class="line"><span class="comment">//   101</span></span><br><span class="line"><span class="comment">//   114</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> value <span class="keyword">of</span> buf) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Prints:</span></span><br><span class="line"><span class="comment">//   98</span></span><br><span class="line"><span class="comment">//   117</span></span><br><span class="line"><span class="comment">//   102</span></span><br><span class="line"><span class="comment">//   102</span></span><br><span class="line"><span class="comment">//   101</span></span><br><span class="line"><span class="comment">//   114</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.alloc(<span class="number">256</span>);</span><br><span class="line"><span class="keyword">const</span> len = buf.write(<span class="string">'\u00bd + \u00bc = \u00be'</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;len&#125;</span> bytes: <span class="subst">$&#123;buf.toString(<span class="string">'utf8'</span>, <span class="number">0</span>, len)&#125;</span>`</span>);</span><br><span class="line"><span class="comment">// Prints: 12 bytes: ½ + ¼ = ¾</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">8</span>);</span><br><span class="line">buf.writeBigInt64BE(<span class="number">0x0102030405060708n</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 01 02 03 04 05 06 07 08&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">8</span>);</span><br><span class="line">buf.writeBigUInt64LE(<span class="number">0xdecafafecacefaden</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer de fa ce ca fe fa ca de&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">8</span>);</span><br><span class="line">buf.writeDoubleBE(<span class="number">123.456</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 40 5e dd 2f 1a 9f be 77&gt;</span></span><br><span class="line">buf.writeDoubleLE(<span class="number">123.456</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 77 be 9f 1a 2f dd 5e 40&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">4</span>);</span><br><span class="line">buf.writeFloatBE(<span class="number">0xcafebabe</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 4f 4a fe bb&gt;</span></span><br><span class="line">buf.writeFloatLE(<span class="number">0xcafebabe</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer bb fe 4a 4f&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">2</span>);</span><br><span class="line">buf.writeInt8(<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">buf.writeInt8(<span class="number">-2</span>, <span class="number">1</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 02 fe&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">4</span>);</span><br><span class="line">buf.writeInt16BE(<span class="number">0x0102</span>, <span class="number">0</span>);</span><br><span class="line">buf.writeInt16LE(<span class="number">0x0304</span>, <span class="number">2</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 01 02 04 03&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">8</span>);</span><br><span class="line">buf.writeInt32BE(<span class="number">0x01020304</span>, <span class="number">0</span>);</span><br><span class="line">buf.writeInt32LE(<span class="number">0x05060708</span>, <span class="number">4</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 01 02 03 04 08 07 06 05&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">6</span>);</span><br><span class="line">buf.writeIntBE(<span class="number">0x1234567890ab</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 12 34 56 78 90 ab&gt;</span></span><br><span class="line">buf.writeIntLE(<span class="number">0x1234567890ab</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer ab 90 78 56 34 12&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">4</span>);</span><br><span class="line">buf.writeUInt8(<span class="number">0x3</span>, <span class="number">0</span>);</span><br><span class="line">buf.writeUInt8(<span class="number">0x4</span>, <span class="number">1</span>);</span><br><span class="line">buf.writeUInt8(<span class="number">0x23</span>, <span class="number">2</span>);</span><br><span class="line">buf.writeUInt8(<span class="number">0x42</span>, <span class="number">3</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 03 04 23 42&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">4</span>);</span><br><span class="line">buf.writeUInt16BE(<span class="number">0xdead</span>, <span class="number">0</span>);</span><br><span class="line">buf.writeUInt16BE(<span class="number">0xbeef</span>, <span class="number">2</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer de ad be ef&gt;</span></span><br><span class="line">buf.writeUInt16LE(<span class="number">0xdead</span>, <span class="number">0</span>);</span><br><span class="line">buf.writeUInt16LE(<span class="number">0xbeef</span>, <span class="number">2</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer ad de ef be&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">4</span>);</span><br><span class="line">buf.writeUInt32BE(<span class="number">0xfeedface</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer fe ed fa ce&gt;</span></span><br><span class="line">buf.writeUInt32LE(<span class="number">0xfeedface</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer ce fa ed fe&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf = Buffer.allocUnsafe(<span class="number">6</span>);</span><br><span class="line">buf.writeUIntBE(<span class="number">0x1234567890ab</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 12 34 56 78 90 ab&gt;</span></span><br><span class="line">buf.writeUIntLE(<span class="number">0x1234567890ab</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer ab 90 78 56 34 12&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buffer = <span class="built_in">require</span>(<span class="string">'buffer'</span>);</span><br><span class="line"><span class="keyword">const</span> newBuf = buffer.transcode(Buffer.from(<span class="string">'€'</span>), <span class="string">'utf8'</span>, <span class="string">'ascii'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(newBuf.toString(<span class="string">'ascii'</span>));</span><br><span class="line"><span class="comment">// Prints: '?'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Need to keep around a few small chunks of memory.</span></span><br><span class="line"><span class="keyword">const</span> store = [];</span><br><span class="line">socket.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> data;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">null</span> !== (data = readable.read())) &#123;</span><br><span class="line">    <span class="comment">// Allocate for retained data.</span></span><br><span class="line">    <span class="keyword">const</span> sb = SlowBuffer(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// Copy the data into the new allocation.</span></span><br><span class="line">    data.copy(sb, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    store.push(sb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; SlowBuffer &#125; = <span class="built_in">require</span>(<span class="string">'buffer'</span>);</span><br><span class="line"><span class="keyword">const</span> buf = <span class="keyword">new</span> SlowBuffer(<span class="number">5</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: (contents may vary): &lt;Buffer 78 e0 82 02 01&gt;</span></span><br><span class="line">buf.fill(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf);</span><br><span class="line"><span class="comment">// Prints: &lt;Buffer 00 00 00 00 00&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-queueMicrotask"><a href="#5-queueMicrotask" class="headerlink" title="5. queueMicrotask"></a>5. queueMicrotask</h2><p>该queueMicrotask()方法将微任务排队以调用callback。如果callback抛出异常，则将 引发 <a href="https://nodejs.org/dist/latest-v13.x/docs/api/process.html#process_process" target="_blank" rel="noopener">process对象</a> ‘uncaughtException’ 事件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Here, `queueMicrotask()` is used to ensure the 'load' event is always</span></span><br><span class="line"><span class="comment">// emitted asynchronously, and therefore consistently. Using</span></span><br><span class="line"><span class="comment">// `process.nextTick()` here would result in the 'load' event always emitting</span></span><br><span class="line"><span class="comment">// before any other promise jobs.</span></span><br><span class="line">DataHandler.prototype.load = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hit = <span class="keyword">this</span>._cache.get(url);</span><br><span class="line">  <span class="keyword">if</span> (hit !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    queueMicrotask(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.emit(<span class="string">'load'</span>, hit);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> fetchData(key);</span><br><span class="line">  <span class="keyword">this</span>._cache.set(url, data);</span><br><span class="line">  <span class="keyword">this</span>.emit(<span class="string">'load'</span>, data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="6-require"><a href="#6-require" class="headerlink" title="6. require()"></a>6. require()</h2><p>加载模块，CommonJS风格，核心为 <code>require</code> 语句</p>
<h3 id="6-1-require-X"><a href="#6-1-require-X" class="headerlink" title="6.1. require(X)"></a>6.1. require(X)</h3><ol>
<li><p>X 为内置模块时，如：require(‘http’)</p>
<ol>
<li>返回该模块</li>
<li>不再继续执行</li>
</ol>
</li>
<li><p>X 以 <code>./</code> 或 <code>/</code> 或 <code>../</code> 开头</p>
<ol>
<li><p>根据 X 所在的父模块，确定 X 的绝对路径</p>
</li>
<li><p>将 X 当成文件，依次查找下面文件，只要其中有一个存在，就返回该文件，不再继续执行</p>
<p> X<br> X.js<br> X.json<br> X.node</p>
</li>
<li><p>将 X 当成目录，依次查找下面文件，只要其中有一个存在，就返回该文件，不再继续执行</p>
<p> X/package.json (main字段)<br> X/index.js<br> X/index.json<br> X/index.node</p>
</li>
</ol>
</li>
<li><p>X 不带路径</p>
<ol>
<li><p>根据 X 所在的父模块，确定 X 可能的安装目录</p>
</li>
<li><p>依次在每个目录中，将 X 当成文件名或目录名加载</p>
<p> require(‘bar’)</p>
<p> /home/ry/projects/node_modules/bar<br> /home/ry/node_modules/bar<br> /home/node_modules/bar<br> /node_modules/bar6:<br> C:\Users*<strong>.node_modules<br> C:\Users*</strong>.node_libraries<br> 安装目录\lib\node</p>
<p> bar<br> bar.js<br> bar.json<br> bar.node</p>
<p> bar/package.json (main字段)<br> bar/index.js<br> bar/index.json<br> bar/index.node</p>
</li>
</ol>
</li>
<li><p>抛出 <code>not found</code></p>
</li>
</ol>
<h3 id="6-2-module"><a href="#6-2-module" class="headerlink" title="6.2. module"></a>6.2. module</h3><ol>
<li><p>node 定义了一个构造函数：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Module</span>(<span class="params">id, parent</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = id;</span><br><span class="line">    <span class="keyword">this</span>.exports = &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.parent = parent;</span><br><span class="line">    <span class="keyword">this</span>.filename = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.loaded = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.children = [];</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = Module;</span><br><span class="line"><span class="keyword">var</span> <span class="built_in">module</span> = <span class="keyword">new</span> Module(filename, parent);</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 <code>a.js</code> 测试：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'module.id: '</span>, <span class="built_in">module</span>.id);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'module.exports: '</span>, <span class="built_in">module</span>.exports);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'module.parent: '</span>, <span class="built_in">module</span>.parent);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'module.filename: '</span>, <span class="built_in">module</span>.filename);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'module.loaded: '</span>, <span class="built_in">module</span>.loaded);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'module.children: '</span>, <span class="built_in">module</span>.children);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'module.paths: '</span>, <span class="built_in">module</span>.paths);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'moduls'</span>, <span class="built_in">JSON</span>.stringify(<span class="built_in">module</span>));</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>命令行执行：</p>
<pre><code>node a.js</code></pre><p>输出：</p>
<pre><code>module.id:  .
module.exports:  {}
module.parent:  null
module.filename:  F:\code\local\npmtest\a.js
module.loaded:  false
module.children:  []
module.paths:  [ &apos;F:\\code\\local\\npmtest\\node_modules&apos;,
&apos;F:\\code\\local\\node_modules&apos;,
&apos;F:\\code\\node_modules&apos; ]
moduls {&quot;id&quot;:&quot;.&quot;,&quot;exports&quot;:{},&quot;parent&quot;:null,&quot;filename&quot;:&quot;F:\\code\\local\\npmtest\\a.js&quot;,&quot;loaded&quot;:false,&quot;children&quot;:[],&quot;paths&quot;:[&quot;F:\\code\\local\\npmtest\\node_modules&quot;,&quot;F:\\code\\local\\node_modules&quot;,&quot;F:\\code\\node_modules&quot;]}</code></pre><p>可见 <code>module.paths</code> 查找路径方式， <code>module.loaded</code> 为 <code>false</code> 表示模块未全部加载</p>
<ol start="3">
<li><p>新建 <code>b.js</code>：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>运行 <code>b.js</code>：</p>
<pre><code>node b.js</code></pre><p>输出：</p>
<pre><code>module.id:  F:\code\local\npmtest\a.js
module.exports:  {}
module.parent:  Module {
    id: &apos;.&apos;,
    exports: {},
    parent: null,
    filename: &apos;F:\\code\\local\\npmtest\\b.js&apos;,
    loaded: false,
    children:
    [ Module {
        id: &apos;F:\\code\\local\\npmtest\\a.js&apos;,
        exports: {},
        parent: [Circular],
        filename: &apos;F:\\code\\local\\npmtest\\a.js&apos;,
        loaded: false,
        children: [],
        paths: [Object] 
    } ],
    paths:
    [ &apos;F:\\code\\local\\npmtest\\node_modules&apos;,
        &apos;F:\\code\\local\\node_modules&apos;,
        &apos;F:\\code\\node_modules&apos; ] 
}
module.filename:  F:\code\local\npmtest\a.js
module.loaded:  false
module.children:  []
module.paths:  [ &apos;F:\\code\\local\\npmtest\\node_modules&apos;,
&apos;F:\\code\\local\\node_modules&apos;,
&apos;F:\\code\\node_modules&apos; ]</code></pre><p>可见 <code>module.parent</code> 指向 <code>b.js</code></p>
<h3 id="6-3-模块实例的-require-方法"><a href="#6-3-模块实例的-require-方法" class="headerlink" title="6.3. 模块实例的 require 方法"></a>6.3. 模块实例的 require 方法</h3><ol>
<li><p>每个模块实例都有一个 <code>require</code> 方法</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.require = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Module._load(path, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>可知，<code>require</code> 不是全局命令，是每个模块提供的一个内部方法，只有在模块内部才能使用 <code>require</code> 命令(REPL环境除外)<br><code>require</code> 内部调用 Module._load 方法</p>
<ol start="2">
<li><p><code>Module._load</code> 源码：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">Module._load = <span class="function"><span class="keyword">function</span>(<span class="params">request, parent, isMain</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">        debug(<span class="string">'Module._load REQUEST %s parent: %s'</span>, request, parent.id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算绝对路径</span></span><br><span class="line">    <span class="keyword">var</span> filename = Module._resolveFilename(request, parent, isMain);</span><br><span class="line">    <span class="comment">// 第一步：如果有缓存，取出缓存</span></span><br><span class="line">    <span class="keyword">var</span> cachedModule = Module._cache[filename];</span><br><span class="line">    <span class="keyword">if</span> (cachedModule) &#123;</span><br><span class="line">        <span class="keyword">return</span> cachedModule.exports;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第二步：是否为内置模块</span></span><br><span class="line">    <span class="keyword">if</span> (NativeModule.nonInternalExists(filename)) &#123;</span><br><span class="line">        debug(<span class="string">'load native module %s'</span>, request);</span><br><span class="line">        <span class="keyword">return</span> NativeModule.require(filename);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第三步：生成模块实例，存入缓存</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = <span class="keyword">new</span> Module(filename, parent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isMain) &#123;</span><br><span class="line">        process.mainModule = <span class="built_in">module</span>;</span><br><span class="line">        <span class="built_in">module</span>.id = <span class="string">'.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Module._cache[filename] = <span class="built_in">module</span>;</span><br><span class="line">    <span class="comment">// 第四步：加载模块</span></span><br><span class="line">    tryModuleLoad(<span class="built_in">module</span>, filename);</span><br><span class="line">    <span class="comment">// 第五步：输出模块的exports属性</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryModuleLoad</span>(<span class="params">module, filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> threw = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">module</span>.load(filename);</span><br><span class="line">        threw = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (threw) &#123;</span><br><span class="line">            <span class="keyword">delete</span> Module._cache[filename];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Module._resolveFilename = <span class="function"><span class="keyword">function</span>(<span class="params">request, parent, isMain</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 第一步：如果是内置模块，不含路径返回</span></span><br><span class="line">    <span class="keyword">if</span> (NativeModule.nonInternalExists(request)) &#123;</span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第二步：确定所有可能的路径</span></span><br><span class="line">    <span class="keyword">var</span> resolvedModule = Module._resolveLookupPaths(request, parent);</span><br><span class="line">    <span class="keyword">var</span> id = resolvedModule[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> paths = resolvedModule[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// look up the filename first, since that's the cache key.</span></span><br><span class="line">    debug(<span class="string">'looking for %j in %j'</span>, id, paths);</span><br><span class="line">    <span class="comment">// 第三步：确定哪一个路径为真</span></span><br><span class="line">    <span class="keyword">var</span> filename = Module._findPath(request, paths, isMain);</span><br><span class="line">    <span class="keyword">if</span> (!filename) &#123;</span><br><span class="line">        <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Cannot find module '"</span> + request + <span class="string">"'"</span>);</span><br><span class="line">        err.code = <span class="string">'MODULE_NOT_FOUND'</span>;</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> filename;</span><br><span class="line">&#125;;</span><br><span class="line">Module._findPath = <span class="function"><span class="keyword">function</span>(<span class="params">request, paths, isMain</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果是绝对路径，就不再搜索</span></span><br><span class="line">    <span class="keyword">if</span> (path.isAbsolute(request)) &#123;</span><br><span class="line">        paths = [<span class="string">''</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!paths || paths.length === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果当前路径已在缓存中，就直接返回缓存</span></span><br><span class="line">    <span class="keyword">const</span> cacheKey = <span class="built_in">JSON</span>.stringify(&#123;<span class="attr">request</span>: request, <span class="attr">paths</span>: paths&#125;);</span><br><span class="line">    <span class="keyword">if</span> (Module._pathCache[cacheKey]) &#123;</span><br><span class="line">        <span class="keyword">return</span> Module._pathCache[cacheKey];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 列出所有可能的后缀名：.js，.json, .node</span></span><br><span class="line">    <span class="keyword">var</span> exts;</span><br><span class="line">    <span class="keyword">const</span> trailingSlash = request.length &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                            request.charCodeAt(request.length - <span class="number">1</span>) === <span class="number">47</span><span class="comment">/*/*/</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For each path</span></span><br><span class="line">    <span class="comment">// 依次遍历所有路径</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; paths.length; i++) &#123;</span><br><span class="line">        <span class="comment">// Don't search further if path doesn't exist</span></span><br><span class="line">        <span class="keyword">const</span> curPath = paths[i];</span><br><span class="line">        <span class="keyword">if</span> (curPath &amp;&amp; stat(curPath) &lt; <span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">var</span> basePath = path.resolve(curPath, request);</span><br><span class="line">        <span class="keyword">var</span> filename;</span><br><span class="line">        <span class="comment">// 是否存在该模块文件</span></span><br><span class="line">        <span class="keyword">if</span> (!trailingSlash) &#123;</span><br><span class="line">            <span class="keyword">const</span> rc = stat(basePath);</span><br><span class="line">            <span class="keyword">if</span> (rc === <span class="number">0</span>) &#123;  <span class="comment">// File.</span></span><br><span class="line">                <span class="keyword">if</span> (preserveSymlinks &amp;&amp; !isMain) &#123;</span><br><span class="line">                    filename = path.resolve(basePath);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    filename = fs.realpathSync(basePath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc === <span class="number">1</span>) &#123;  <span class="comment">// Directory.</span></span><br><span class="line">                <span class="keyword">if</span> (exts === <span class="literal">undefined</span>)</span><br><span class="line">                    exts = <span class="built_in">Object</span>.keys(Module._extensions);</span><br><span class="line">                filename = tryPackage(basePath, exts, isMain);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!filename) &#123;</span><br><span class="line">                <span class="comment">// try it with each of the extensions</span></span><br><span class="line">                <span class="keyword">if</span> (exts === <span class="literal">undefined</span>)</span><br><span class="line">                    exts = <span class="built_in">Object</span>.keys(Module._extensions);</span><br><span class="line">                <span class="comment">// 该模块文件加上后缀名，是否存在</span></span><br><span class="line">                filename = tryExtensions(basePath, exts, isMain);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 目录中是否存在 package.json </span></span><br><span class="line">        <span class="keyword">if</span> (!filename) &#123;</span><br><span class="line">            <span class="keyword">if</span> (exts === <span class="literal">undefined</span>)</span><br><span class="line">                exts = <span class="built_in">Object</span>.keys(Module._extensions);</span><br><span class="line">            filename = tryPackage(basePath, exts, isMain);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 是否存在目录名 + index + 后缀名 </span></span><br><span class="line">        <span class="keyword">if</span> (!filename) &#123;</span><br><span class="line">            <span class="comment">// try it with each of the extensions at "index"</span></span><br><span class="line">            <span class="keyword">if</span> (exts === <span class="literal">undefined</span>)</span><br><span class="line">                exts = <span class="built_in">Object</span>.keys(Module._extensions);</span><br><span class="line">            filename = tryExtensions(path.resolve(basePath, <span class="string">'index'</span>), exts, isMain);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将找到的文件路径存入返回缓存，然后返回</span></span><br><span class="line">        <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">            <span class="comment">// Warn once if '.' resolved outside the module dir</span></span><br><span class="line">            <span class="keyword">if</span> (request === <span class="string">'.'</span> &amp;&amp; i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                warned = internalUtil.printDeprecationMessage(</span><br><span class="line">                <span class="string">'warning: require(\'.\') resolved outside the package '</span> +</span><br><span class="line">                <span class="string">'directory. This functionality is deprecated and will be removed '</span> +</span><br><span class="line">                <span class="string">'soon.'</span>, warned);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Module._pathCache[cacheKey] = filename;</span><br><span class="line">            <span class="keyword">return</span> filename;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>require.resolve</code> 用于从模块名取到绝对路径</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>.resolve = <span class="function"><span class="keyword">function</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Module._resolveFilename(request, self);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>创建 <code>c.js</code>：</p>
<pre><code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>.resolve(<span class="string">'./a.js'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br></pre></td></tr></table></figure></code></pre><p>输出：</p>
<pre><code>F:\code\local\npmtest\a.js</code></pre><h3 id="6-4-加载模块"><a href="#6-4-加载模块" class="headerlink" title="6.4. 加载模块"></a>6.4. 加载模块</h3><ol>
<li><p><code>module.load</code> 源码：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.load = <span class="function"><span class="keyword">function</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">    debug(<span class="string">'load %j for module %j'</span>, filename, <span class="keyword">this</span>.id);</span><br><span class="line"></span><br><span class="line">    assert(!<span class="keyword">this</span>.loaded);</span><br><span class="line">    <span class="keyword">this</span>.filename = filename;</span><br><span class="line">    <span class="keyword">this</span>.paths = Module._nodeModulePaths(path.dirname(filename));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> extension = path.extname(filename) || <span class="string">'.js'</span>;</span><br><span class="line">    <span class="keyword">if</span> (!Module._extensions[extension]) extension = <span class="string">'.js'</span>;</span><br><span class="line">    Module._extensions[extension](<span class="keyword">this</span>, filename);</span><br><span class="line">    <span class="keyword">this</span>.loaded = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>确定模块的后缀名，不同后缀名对应不同加载方法，如：</p>
<pre><code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Native extension for .js</span></span><br><span class="line">Module._extensions[<span class="string">'.js'</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">module, filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> content = fs.readFileSync(filename, <span class="string">'utf8'</span>);</span><br><span class="line">    <span class="built_in">module</span>._compile(internalModule.stripBOM(content), filename);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Native extension for .json</span></span><br><span class="line">Module._extensions[<span class="string">'.json'</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">module, filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> content = fs.readFileSync(filename, <span class="string">'utf8'</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">module</span>.exports = <span class="built_in">JSON</span>.parse(internalModule.stripBOM(content));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        err.message = filename + <span class="string">': '</span> + err.message;</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//Native extension for .node</span></span><br><span class="line">Module._extensions[<span class="string">'.node'</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">module, filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> process.dlopen(<span class="built_in">module</span>, path._makeLong(filename));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></code></pre><p>对于 <code>js</code> 文件，将模块文件读取成字符串，去掉 <code>BOM</code> 头，编译模块：</p>
<pre><code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype._compile = <span class="function"><span class="keyword">function</span>(<span class="params">content, filename</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Remove shebang</span></span><br><span class="line">    <span class="keyword">var</span> contLen = content.length;</span><br><span class="line">    <span class="keyword">if</span> (contLen &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (content.charCodeAt(<span class="number">0</span>) === <span class="number">35</span><span class="comment">/*#*/</span> &amp;&amp;</span><br><span class="line">            content.charCodeAt(<span class="number">1</span>) === <span class="number">33</span><span class="comment">/*!*/</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (contLen === <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="comment">// Exact match</span></span><br><span class="line">                content = <span class="string">''</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Find end of shebang line and slice it off</span></span><br><span class="line">                <span class="keyword">var</span> i = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">for</span> (; i &lt; contLen; ++i) &#123;</span><br><span class="line">                    <span class="keyword">var</span> code = content.charCodeAt(i);</span><br><span class="line">                    <span class="keyword">if</span> (code === <span class="number">10</span><span class="comment">/*\n*/</span> || code === <span class="number">13</span><span class="comment">/*\r*/</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (i === contLen)</span><br><span class="line">                    content = <span class="string">''</span>;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Note that this actually includes the newline character(s) in the</span></span><br><span class="line">                    <span class="comment">// new output. This duplicates the behavior of the regular expression</span></span><br><span class="line">                    <span class="comment">// that was previously used to replace the shebang line</span></span><br><span class="line">                    content = content.slice(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// create wrapper function</span></span><br><span class="line">    <span class="keyword">var</span> wrapper = Module.wrap(content);</span><br><span class="line">    <span class="keyword">var</span> compiledWrapper = vm.runInThisContext(wrapper, &#123;</span><br><span class="line">        filename: filename,</span><br><span class="line">        lineOffset: <span class="number">0</span>,</span><br><span class="line">        displayErrors: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (process._debugWaitConnect) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!resolvedArgv) &#123;</span><br><span class="line">            <span class="comment">// we enter the repl if we're not given a filename argument.</span></span><br><span class="line">            <span class="keyword">if</span> (process.argv[<span class="number">1</span>]) &#123;</span><br><span class="line">                resolvedArgv = Module._resolveFilename(process.argv[<span class="number">1</span>], <span class="literal">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resolvedArgv = <span class="string">'repl'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Set breakpoint on module start</span></span><br><span class="line">        <span class="keyword">if</span> (filename === resolvedArgv) &#123;</span><br><span class="line">            <span class="keyword">delete</span> process._debugWaitConnect;</span><br><span class="line">            <span class="keyword">const</span> Debug = vm.runInDebugContext(<span class="string">'Debug'</span>);</span><br><span class="line">            Debug.setBreakPoint(compiledWrapper, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> dirname = path.dirname(filename);</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">require</span> = internalModule.makeRequireFunction.call(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">var</span> args = [<span class="keyword">this</span>.exports, <span class="built_in">require</span>, <span class="keyword">this</span>, filename, dirname];</span><br><span class="line">    <span class="keyword">var</span> depth = internalModule.requireDepth;</span><br><span class="line">    <span class="keyword">if</span> (depth === <span class="number">0</span>) stat.cache = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="keyword">var</span> result = compiledWrapper.apply(<span class="keyword">this</span>.exports, args);</span><br><span class="line">    <span class="keyword">if</span> (depth === <span class="number">0</span>) stat.cache = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></code></pre><p>上面代码基本等同于：</p>
<pre><code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">exports, require, module, __filename, __dirname</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 模块源码</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></code></pre><p>模块加载实际上是注入 <code>exports</code>、<code>require</code>、<code>module</code> 三个全局变量，然后执行模块的源码，将模块的 <code>exports</code> 变量值输出</p>
<h1 id="4-内置模块及常用方法"><a href="#4-内置模块及常用方法" class="headerlink" title="4. 内置模块及常用方法"></a>4. 内置模块及常用方法</h1><p>内置模块调用方法，如 <code>util</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br></pre></td></tr></table></figure>

<h2 id="1-util"><a href="#1-util" class="headerlink" title="1. util"></a>1. util</h2><h2 id="3-dns"><a href="#3-dns" class="headerlink" title="3. dns"></a>3. dns</h2><pre><code>dns.lookup()
dns.lookupService()</code></pre><h2 id="4-http"><a href="#4-http" class="headerlink" title="4. http"></a>4. http</h2><h2 id="5-crypto"><a href="#5-crypto" class="headerlink" title="5. crypto"></a>5. crypto</h2><h2 id="6-fs"><a href="#6-fs" class="headerlink" title="6. fs"></a>6. fs</h2><pre><code>fs.FSWatcher()</code></pre><h2 id="7-zlib"><a href="#7-zlib" class="headerlink" title="7. zlib"></a>7. zlib</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> gzip = <span class="built_in">require</span>(<span class="string">'zlib'</span>).createGzip();</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> inp = fs.createReadStream(<span class="string">'The.Matrix.1080p.mkv'</span>);</span><br><span class="line"><span class="keyword">const</span> out = fs.createWriteStream(<span class="string">'The.Matrix.1080p.mkv.gz'</span>);</span><br><span class="line">inp.pipe(gzip).pipe(out);</span><br></pre></td></tr></table></figure>

<h2 id="8-child-process"><a href="#8-child-process" class="headerlink" title="8. child_process"></a>8. child_process</h2><h2 id="9-net"><a href="#9-net" class="headerlink" title="9. net"></a>9. net</h2><p>模块为创建基于流的 <code>TCP/IPC</code> 服务器(<code>net.createServer()</code>)和客户端(<code>net.createConnection</code>)提供异步网络API</p>
<p>为 <code>IPC</code> 标识路径连接：</p>
<pre><code>net.connect()
net.createConnection()
server.listen()
socket.connect()</code></pre><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.createServer().listen(path.join(<span class="string">'\\\\?\\pipe'</span>, process.cwd(), <span class="string">'myctl'</span>));</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = net.createServer(<span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">  socket.end(<span class="string">'goodbye\n'</span>);</span><br><span class="line">&#125;).on(<span class="string">'error'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Handle errors here.</span></span><br><span class="line">  <span class="keyword">if</span> (e.code === <span class="string">'EADDRINUSE'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Address in use, retrying...'</span>);</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      server.close();</span><br><span class="line">      server.listen(PORT, HOST);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> err;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Grab an arbitrary unused port.</span></span><br><span class="line">server.listen(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'opened server on'</span>, server.address());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server.listen(&#123;</span><br><span class="line">  host: <span class="string">'localhost'</span>,</span><br><span class="line">  port: <span class="number">80</span>,</span><br><span class="line">  exclusive: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</span><br><span class="line">net.connect(&#123;</span><br><span class="line">  port: <span class="number">80</span>,</span><br><span class="line">  onread: &#123;</span><br><span class="line">    <span class="comment">// Reuses a 4KiB Buffer for every read from the socket.</span></span><br><span class="line">    buffer: Buffer.alloc(<span class="number">4</span> * <span class="number">1024</span>),</span><br><span class="line">    callback: <span class="function"><span class="keyword">function</span>(<span class="params">nread, buf</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// Received data is available in `buf` from 0 to `nread`.</span></span><br><span class="line">      <span class="built_in">console</span>.log(buf.toString(<span class="string">'utf8'</span>, <span class="number">0</span>, nread));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">socket.setTimeout(<span class="number">3000</span>);</span><br><span class="line">socket.on(<span class="string">'timeout'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'socket timeout'</span>);</span><br><span class="line">  socket.end();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</span><br><span class="line"><span class="keyword">const</span> client = net.createConnection(&#123; <span class="attr">port</span>: <span class="number">8124</span> &#125;, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 'connect' listener.</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'connected to server!'</span>);</span><br><span class="line">  client.write(<span class="string">'world!\r\n'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">client.on(<span class="string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data.toString());</span><br><span class="line">  client.end();</span><br><span class="line">&#125;);</span><br><span class="line">client.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'disconnected from server'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = net.createConnection(&#123; <span class="attr">path</span>: <span class="string">'/tmp/echo.sock'</span> &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</span><br><span class="line"><span class="keyword">const</span> server = net.createServer(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 'connection' listener.</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'client connected'</span>);</span><br><span class="line">  c.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'client disconnected'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  c.write(<span class="string">'hello\r\n'</span>);</span><br><span class="line">  c.pipe(c);</span><br><span class="line">&#125;);</span><br><span class="line">server.on(<span class="string">'error'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="keyword">throw</span> err;</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">8124</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server bound'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ telnet localhost <span class="number">8124</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.listen(<span class="string">'/tmp/echo.sock'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server bound'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -U /tmp/echo.sock</span><br></pre></td></tr></table></figure>

<h2 id="10-stream"><a href="#10-stream" class="headerlink" title="10. stream"></a>10. stream</h2><p>用于 Node 处理流数据的抽象接口，提供了用于实现流接口的API</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// `req` is an http.IncomingMessage, which is a Readable Stream.</span></span><br><span class="line">  <span class="comment">// `res` is an http.ServerResponse, which is a Writable Stream.</span></span><br><span class="line">  <span class="keyword">let</span> body = <span class="string">''</span>;</span><br><span class="line">  <span class="comment">// Get the data as utf8 strings.</span></span><br><span class="line">  <span class="comment">// If an encoding is not set, Buffer objects will be received.</span></span><br><span class="line">  req.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">  <span class="comment">// Readable streams emit 'data' events once a listener is added.</span></span><br><span class="line">  req.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">    body += chunk;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// The 'end' event indicates that the entire body has been received.</span></span><br><span class="line">  req.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(body);</span><br><span class="line">      <span class="comment">// Write back something interesting to the user:</span></span><br><span class="line">      res.write(<span class="keyword">typeof</span> data);</span><br><span class="line">      res.end();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (er) &#123;</span><br><span class="line">      <span class="comment">// uh oh! bad json!</span></span><br><span class="line">      res.statusCode = <span class="number">400</span>;</span><br><span class="line">      <span class="keyword">return</span> res.end(<span class="string">`error: <span class="subst">$&#123;er.message&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">1337</span>);</span><br><span class="line"><span class="comment">// $ curl localhost:1337 -d "&#123;&#125;"</span></span><br><span class="line"><span class="comment">// object</span></span><br><span class="line"><span class="comment">// $ curl localhost:1337 -d "\"foo\""</span></span><br><span class="line"><span class="comment">// string</span></span><br><span class="line"><span class="comment">// $ curl localhost:1337 -d "not json"</span></span><br><span class="line"><span class="comment">// error: Unexpected token o in JSON at position 1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myStream = getWritableStreamSomehow();</span><br><span class="line">myStream.write(<span class="string">'some data'</span>);</span><br><span class="line">myStream.write(<span class="string">'some more data'</span>);</span><br><span class="line">myStream.end(<span class="string">'done writing data'</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Write the data to the supplied writable stream one million times.</span></span><br><span class="line"><span class="comment">// Be attentive to back-pressure.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeOneMillionTimes</span>(<span class="params">writer, data, encoding, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">1000000</span>;</span><br><span class="line">  write();</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> ok = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      i--;</span><br><span class="line">      <span class="keyword">if</span> (i === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Last time!</span></span><br><span class="line">        writer.write(data, encoding, callback);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// See if we should continue, or wait.</span></span><br><span class="line">        <span class="comment">// Don't pass the callback, because we're not done yet.</span></span><br><span class="line">        ok = writer.write(data, encoding);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (i &gt; <span class="number">0</span> &amp;&amp; ok);</span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Had to stop early!</span></span><br><span class="line">      <span class="comment">// Write some more once it drains.</span></span><br><span class="line">      writer.once(<span class="string">'drain'</span>, write);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> writer = getWritableStreamSomehow();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">  writer.write(<span class="string">`hello, #<span class="subst">$&#123;i&#125;</span>!\n`</span>);</span><br><span class="line">&#125;</span><br><span class="line">writer.end(<span class="string">'This is the end\n'</span>);</span><br><span class="line">writer.on(<span class="string">'finish'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'All writes are now complete.'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> writer = getWritableStreamSomehow();</span><br><span class="line"><span class="keyword">const</span> reader = getReadableStreamSomehow();</span><br><span class="line">writer.on(<span class="string">'pipe'</span>, (src) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Something is piping into the writer.'</span>);</span><br><span class="line">  assert.equal(src, reader);</span><br><span class="line">&#125;);</span><br><span class="line">reader.pipe(writer);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> writer = getWritableStreamSomehow();</span><br><span class="line"><span class="keyword">const</span> reader = getReadableStreamSomehow();</span><br><span class="line">writer.on(<span class="string">'unpipe'</span>, (src) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Something has stopped piping into the writer.'</span>);</span><br><span class="line">  assert.equal(src, reader);</span><br><span class="line">&#125;);</span><br><span class="line">reader.pipe(writer);</span><br><span class="line">reader.unpipe(writer);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Write 'hello, ' and then end with 'world!'.</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> file = fs.createWriteStream(<span class="string">'example.txt'</span>);</span><br><span class="line">file.write(<span class="string">'hello, '</span>);</span><br><span class="line">file.end(<span class="string">'world!'</span>);</span><br><span class="line"><span class="comment">// Writing more now is not allowed!</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stream.cork();</span><br><span class="line">stream.write(<span class="string">'some '</span>);</span><br><span class="line">stream.write(<span class="string">'data '</span>);</span><br><span class="line">process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> stream.uncork());</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stream.cork();</span><br><span class="line">stream.write(<span class="string">'some '</span>);</span><br><span class="line">stream.cork();</span><br><span class="line">stream.write(<span class="string">'data '</span>);</span><br><span class="line">process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  stream.uncork();</span><br><span class="line">  <span class="comment">// The data will not be flushed until uncork() is called a second time.</span></span><br><span class="line">  stream.uncork();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">data, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!stream.write(data)) &#123;</span><br><span class="line">    stream.once(<span class="string">'drain'</span>, cb);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    process.nextTick(cb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Wait for cb to be called before doing any other write.</span></span><br><span class="line">write(<span class="string">'hello'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Write completed, do more writes now.'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; PassThrough, Writable &#125; = <span class="built_in">require</span>(<span class="string">'stream'</span>);</span><br><span class="line"><span class="keyword">const</span> pass = <span class="keyword">new</span> PassThrough();</span><br><span class="line"><span class="keyword">const</span> writable = <span class="keyword">new</span> Writable();</span><br><span class="line">pass.pipe(writable);</span><br><span class="line">pass.unpipe(writable);</span><br><span class="line"><span class="comment">// readableFlowing is now false.</span></span><br><span class="line">pass.on(<span class="string">'data'</span>, (chunk) =&gt; &#123; <span class="built_in">console</span>.log(chunk.toString()); &#125;);</span><br><span class="line">pass.write(<span class="string">'ok'</span>);  <span class="comment">// Will not emit 'data'.</span></span><br><span class="line">pass.resume();     <span class="comment">// Must be called to make stream emit 'data'.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readable = getReadableStreamSomehow();</span><br><span class="line">readable.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;chunk.length&#125;</span> bytes of data.`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readable = getReadableStreamSomehow();</span><br><span class="line">readable.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;chunk.length&#125;</span> bytes of data.`</span>);</span><br><span class="line">&#125;);</span><br><span class="line">readable.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'There will be no more data.'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readable = getReadableStreamSomehow();</span><br><span class="line">readable.on(<span class="string">'readable'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// There is some data to read now.</span></span><br><span class="line">  <span class="keyword">let</span> data;</span><br><span class="line">  <span class="keyword">while</span> (data = <span class="keyword">this</span>.read()) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> rr = fs.createReadStream(<span class="string">'foo.txt'</span>);</span><br><span class="line">rr.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`readable: <span class="subst">$&#123;rr.read()&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line">rr.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'end'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// $ node test.js</span></span><br><span class="line"><span class="comment">// readable: null</span></span><br><span class="line"><span class="comment">// end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readable = <span class="keyword">new</span> stream.Readable();</span><br><span class="line">readable.isPaused(); <span class="comment">// === false</span></span><br><span class="line">readable.pause();</span><br><span class="line">readable.isPaused(); <span class="comment">// === true</span></span><br><span class="line">readable.resume();</span><br><span class="line">readable.isPaused(); <span class="comment">// === false</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readable = getReadableStreamSomehow();</span><br><span class="line">readable.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;chunk.length&#125;</span> bytes of data.`</span>);</span><br><span class="line">  readable.pause();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'There will be no additional data for 1 second.'</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Now data will start flowing again.'</span>);</span><br><span class="line">    readable.resume();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> readable = getReadableStreamSomehow();</span><br><span class="line"><span class="keyword">const</span> writable = fs.createWriteStream(<span class="string">'file.txt'</span>);</span><br><span class="line"><span class="comment">// All the data from readable goes into 'file.txt'.</span></span><br><span class="line">readable.pipe(writable);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> r = fs.createReadStream(<span class="string">'file.txt'</span>);</span><br><span class="line"><span class="keyword">const</span> z = zlib.createGzip();</span><br><span class="line"><span class="keyword">const</span> w = fs.createWriteStream(<span class="string">'file.txt.gz'</span>);</span><br><span class="line">r.pipe(z).pipe(w);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reader.pipe(writer, &#123; <span class="attr">end</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">reader.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">  writer.end(<span class="string">'Goodbye\n'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readable = getReadableStreamSomehow();</span><br><span class="line">readable.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> chunk;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">null</span> !== (chunk = readable.read())) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;chunk.length&#125;</span> bytes of data.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getReadableStreamSomehow()</span><br><span class="line">  .resume()</span><br><span class="line">  .on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Reached the end, but did not read anything.'</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readable = getReadableStreamSomehow();</span><br><span class="line">readable.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">readable.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">  assert.equal(<span class="keyword">typeof</span> chunk, <span class="string">'string'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Got %d characters of string data:'</span>, chunk.length);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> readable = getReadableStreamSomehow();</span><br><span class="line"><span class="keyword">const</span> writable = fs.createWriteStream(<span class="string">'file.txt'</span>);</span><br><span class="line"><span class="comment">// All the data from readable goes into 'file.txt',</span></span><br><span class="line"><span class="comment">// but only for the first second.</span></span><br><span class="line">readable.pipe(writable);</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Stop writing to file.txt.'</span>);</span><br><span class="line">  readable.unpipe(writable);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Manually close the file stream.'</span>);</span><br><span class="line">  writable.end();</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pull off a header delimited by \n\n.</span></span><br><span class="line"><span class="comment">// Use unshift() if we get too much.</span></span><br><span class="line"><span class="comment">// Call the callback with (error, header, stream).</span></span><br><span class="line"><span class="keyword">const</span> &#123; StringDecoder &#125; = <span class="built_in">require</span>(<span class="string">'string_decoder'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseHeader</span>(<span class="params">stream, callback</span>) </span>&#123;</span><br><span class="line">  stream.on(<span class="string">'error'</span>, callback);</span><br><span class="line">  stream.on(<span class="string">'readable'</span>, onReadable);</span><br><span class="line">  <span class="keyword">const</span> decoder = <span class="keyword">new</span> StringDecoder(<span class="string">'utf8'</span>);</span><br><span class="line">  <span class="keyword">let</span> header = <span class="string">''</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onReadable</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> chunk;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">null</span> !== (chunk = stream.read())) &#123;</span><br><span class="line">      <span class="keyword">const</span> str = decoder.write(chunk);</span><br><span class="line">      <span class="keyword">if</span> (str.match(<span class="regexp">/\n\n/</span>)) &#123;</span><br><span class="line">        <span class="comment">// Found the header boundary.</span></span><br><span class="line">        <span class="keyword">const</span> split = str.split(<span class="regexp">/\n\n/</span>);</span><br><span class="line">        header += split.shift();</span><br><span class="line">        <span class="keyword">const</span> remaining = split.join(<span class="string">'\n\n'</span>);</span><br><span class="line">        <span class="keyword">const</span> buf = Buffer.from(remaining, <span class="string">'utf8'</span>);</span><br><span class="line">        stream.removeListener(<span class="string">'error'</span>, callback);</span><br><span class="line">        <span class="comment">// Remove the 'readable' listener before unshifting.</span></span><br><span class="line">        stream.removeListener(<span class="string">'readable'</span>, onReadable);</span><br><span class="line">        <span class="keyword">if</span> (buf.length)</span><br><span class="line">          stream.unshift(buf);</span><br><span class="line">        <span class="comment">// Now the body of the message can be read from the stream.</span></span><br><span class="line">        callback(<span class="literal">null</span>, header, stream);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Still reading the header.</span></span><br><span class="line">        header += str;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; OldReader &#125; = <span class="built_in">require</span>(<span class="string">'./old-api-module.js'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; Readable &#125; = <span class="built_in">require</span>(<span class="string">'stream'</span>);</span><br><span class="line"><span class="keyword">const</span> oreader = <span class="keyword">new</span> OldReader();</span><br><span class="line"><span class="keyword">const</span> myReader = <span class="keyword">new</span> Readable().wrap(oreader);</span><br><span class="line"></span><br><span class="line">myReader.on(<span class="string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  myReader.read(); <span class="comment">// etc.</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">readable</span>) </span>&#123;</span><br><span class="line">  readable.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">const</span> chunk <span class="keyword">of</span> readable) &#123;</span><br><span class="line">    data += chunk;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;</span><br><span class="line">print(fs.createReadStream(<span class="string">'file'</span>)).catch(<span class="built_in">console</span>.error);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; finished &#125; = <span class="built_in">require</span>(<span class="string">'stream'</span>);</span><br><span class="line"><span class="keyword">const</span> rs = fs.createReadStream(<span class="string">'archive.tar'</span>);</span><br><span class="line">finished(rs, (err) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'Stream failed.'</span>, err);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Stream is done reading.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">rs.resume(); <span class="comment">// Drain the stream.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> finished = util.promisify(stream.finished);</span><br><span class="line"><span class="keyword">const</span> rs = fs.createReadStream(<span class="string">'archive.tar'</span>);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> finished(rs);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Stream is done reading.'</span>);</span><br><span class="line">&#125;</span><br><span class="line">run().catch(<span class="built_in">console</span>.error);</span><br><span class="line">rs.resume(); <span class="comment">// Drain the stream.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cleanup = finished(rs, (err) =&gt; &#123;</span><br><span class="line">  cleanup();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; pipeline &#125; = <span class="built_in">require</span>(<span class="string">'stream'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">'zlib'</span>);</span><br><span class="line"><span class="comment">// Use the pipeline API to easily pipe a series of streams</span></span><br><span class="line"><span class="comment">// together and get notified when the pipeline is fully done.</span></span><br><span class="line"><span class="comment">// A pipeline to gzip a potentially huge tar file efficiently:</span></span><br><span class="line">pipeline(</span><br><span class="line">  fs.createReadStream(<span class="string">'archive.tar'</span>),</span><br><span class="line">  zlib.createGzip(),</span><br><span class="line">  fs.createWriteStream(<span class="string">'archive.tar.gz'</span>),</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(<span class="string">'Pipeline failed.'</span>, err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Pipeline succeeded.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pipeline = util.promisify(stream.pipeline);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> pipeline(</span><br><span class="line">    fs.createReadStream(<span class="string">'archive.tar'</span>),</span><br><span class="line">    zlib.createGzip(),</span><br><span class="line">    fs.createWriteStream(<span class="string">'archive.tar.gz'</span>)</span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Pipeline succeeded.'</span>);</span><br><span class="line">&#125;</span><br><span class="line">run().catch(<span class="built_in">console</span>.error);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Readable &#125; = <span class="built_in">require</span>(<span class="string">'stream'</span>);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> * <span class="title">generate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'hello'</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'streams'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> readable = Readable.from(generate());</span><br><span class="line">readable.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(chunk);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Writable &#125; = <span class="built_in">require</span>(<span class="string">'stream'</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWritable</span> <span class="keyword">extends</span> <span class="title">Writable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(&#123; highWaterMark, ...options &#125;) &#123;</span><br><span class="line">    <span class="keyword">super</span>(&#123;</span><br><span class="line">      highWaterMark,</span><br><span class="line">      autoDestroy: <span class="literal">true</span>,</span><br><span class="line">      emitClose: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Writable &#125; = <span class="built_in">require</span>(<span class="string">'stream'</span>);</span><br><span class="line"><span class="keyword">const</span> myWritable = <span class="keyword">new</span> Writable(&#123;</span><br><span class="line">  write(chunk, encoding, callback) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 11. readline</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line"><span class="keyword">const</span> readline = <span class="built_in">require</span>(<span class="string">'readline'</span>);</span><br><span class="line"><span class="comment">// process.stdin 和 process.stdout 都是 Stream 的实例</span></span><br><span class="line"><span class="keyword">const</span> rl = readline.createInterface(&#123;</span><br><span class="line">  input: process.stdin,</span><br><span class="line">  output: process.stdout</span><br><span class="line">&#125;);</span><br><span class="line">rl.question(<span class="string">'Why should you use streams? '</span>, (answer) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Maybe it's <span class="subst">$&#123;answer&#125;</span>, maybe it's because they are awesome! :)`</span>);</span><br><span class="line">  rl.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="12-assert"><a href="#12-assert" class="headerlink" title="12. assert"></a>12. assert</h2><p>断言模块提供了一组用于验证不变性的断言函数。 该模块提供了建议的严格模式和更宽松的旧版模式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br><span class="line"><span class="comment">// Generate an AssertionError to compare the error message later:</span></span><br><span class="line"><span class="keyword">const</span> &#123; message &#125; = <span class="keyword">new</span> assert.AssertionError(&#123;</span><br><span class="line">  actual: <span class="number">1</span>,</span><br><span class="line">  expected: <span class="number">2</span>,</span><br><span class="line">  operator: <span class="string">'strictEqual'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Verify error output:</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  assert.strictEqual(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  assert(err <span class="keyword">instanceof</span> assert.AssertionError);</span><br><span class="line">  assert.strictEqual(err.message, message);</span><br><span class="line">  assert.strictEqual(err.name, <span class="string">'AssertionError'</span>);</span><br><span class="line">  assert.strictEqual(err.actual, <span class="number">1</span>);</span><br><span class="line">  assert.strictEqual(err.expected, <span class="number">2</span>);</span><br><span class="line">  assert.strictEqual(err.code, <span class="string">'ERR_ASSERTION'</span>);</span><br><span class="line">  assert.strictEqual(err.operator, <span class="string">'strictEqual'</span>);</span><br><span class="line">  assert.strictEqual(err.generatedMessage, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>).strict;</span><br><span class="line">assert.deepEqual([[[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]], <span class="number">4</span>, <span class="number">5</span>], [[[<span class="number">1</span>, <span class="number">2</span>, <span class="string">'3'</span>]], <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line">assert.deepEqual(<span class="regexp">/a/gi</span>, <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line"></span><br><span class="line">assert.deepEqual(<span class="string">'+00000000'</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj1 = &#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="number">1</span> &#125; &#125;;</span><br><span class="line"><span class="keyword">const</span> obj2 = &#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="number">2</span> &#125; &#125;;</span><br><span class="line"><span class="keyword">const</span> obj3 = &#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="number">1</span> &#125; &#125;;</span><br><span class="line"><span class="keyword">const</span> obj4 = <span class="built_in">Object</span>.create(obj1);</span><br><span class="line">assert.deepEqual(obj1, obj1);</span><br><span class="line">assert.deepEqual(obj1, obj2);</span><br><span class="line">assert.deepEqual(obj1, obj3);</span><br><span class="line">assert.deepEqual(obj1, obj4);</span><br><span class="line"></span><br><span class="line">assert.deepStrictEqual(&#123; <span class="attr">a</span>: <span class="number">1</span> &#125;, &#123; <span class="attr">a</span>: <span class="string">'1'</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"><span class="keyword">const</span> object = &#123;&#125;;</span><br><span class="line"><span class="keyword">const</span> fakeDate = &#123;&#125;;</span><br><span class="line"><span class="built_in">Object</span>.setPrototypeOf(fakeDate, <span class="built_in">Date</span>.prototype);</span><br><span class="line">assert.deepStrictEqual(object, fakeDate);</span><br><span class="line">assert.deepStrictEqual(date, fakeDate);</span><br><span class="line">assert.deepStrictEqual(<span class="literal">NaN</span>, <span class="literal">NaN</span>);c</span><br><span class="line">assert.deepStrictEqual(<span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">1</span>), <span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">2</span>));</span><br><span class="line">assert.deepStrictEqual(<span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">'foo'</span>), <span class="built_in">Object</span>(<span class="string">'foo'</span>));c</span><br><span class="line">assert.deepStrictEqual(<span class="number">-0</span>, <span class="number">-0</span>);</span><br><span class="line">assert.deepStrictEqual(<span class="number">0</span>, <span class="number">-0</span>);</span><br><span class="line"><span class="keyword">const</span> symbol1 = <span class="built_in">Symbol</span>();</span><br><span class="line"><span class="keyword">const</span> symbol2 = <span class="built_in">Symbol</span>();</span><br><span class="line">assert.deepStrictEqual(&#123; [symbol1]: <span class="number">1</span> &#125;, &#123; [symbol1]: <span class="number">1</span> &#125;);</span><br><span class="line">assert.deepStrictEqual(&#123; [symbol1]: <span class="number">1</span> &#125;, &#123; [symbol2]: <span class="number">1</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> weakMap1 = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">const</span> weakMap2 = <span class="keyword">new</span> <span class="built_in">WeakMap</span>([[&#123;&#125;, &#123;&#125;]]);</span><br><span class="line"><span class="keyword">const</span> weakMap3 = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line">weakMap3.unequal = <span class="literal">true</span>;</span><br><span class="line">assert.deepStrictEqual(weakMap1, weakMap2);</span><br><span class="line">assert.deepStrictEqual(weakMap1, weakMap3);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> assert.doesNotReject(</span><br><span class="line">    <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Wrong value'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">SyntaxError</span></span><br><span class="line">  );</span><br><span class="line">&#125;)();</span><br><span class="line">assert.doesNotReject(<span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Wrong value'</span>)))</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">assert.doesNotThrow(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Wrong value'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">SyntaxError</span></span><br><span class="line">);</span><br><span class="line">assert.doesNotThrow(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Wrong value'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  /Wrong value/,</span><br><span class="line">  <span class="string">'Whoops'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">assert.equal(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">assert.equal(<span class="number">1</span>, <span class="string">'1'</span>);</span><br><span class="line">assert.equal(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">assert.equal(&#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="number">1</span> &#125; &#125;, &#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="number">1</span> &#125; &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>).strict;</span><br><span class="line">assert.fail();</span><br><span class="line">assert.fail(<span class="string">'boom'</span>);</span><br><span class="line">assert.fail(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'need array'</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">assert.fail(<span class="string">'a'</span>, <span class="string">'b'</span>);</span><br><span class="line">assert.fail(<span class="number">1</span>, <span class="number">2</span>, <span class="literal">undefined</span>, <span class="string">'&gt;'</span>);</span><br><span class="line">assert.fail(<span class="number">1</span>, <span class="number">2</span>, <span class="string">'fail'</span>);</span><br><span class="line">assert.fail(<span class="number">1</span>, <span class="number">2</span>, <span class="string">'whoops'</span>, <span class="string">'&gt;'</span>);</span><br><span class="line">assert.fail(<span class="number">1</span>, <span class="number">2</span>, <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'need array'</span>));</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">suppressFrame</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  assert.fail(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="literal">undefined</span>, <span class="string">'!=='</span>, suppressFrame);</span><br><span class="line">&#125;</span><br><span class="line">suppressFrame();</span><br><span class="line"></span><br><span class="line">assert.ifError(<span class="literal">null</span>);</span><br><span class="line">assert.ifError(<span class="number">0</span>);</span><br><span class="line">assert.ifError(<span class="string">'error'</span>);</span><br><span class="line">assert.ifError(<span class="keyword">new</span> <span class="built_in">Error</span>());</span><br><span class="line"><span class="keyword">let</span> err;</span><br><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">errorFrame</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'test error'</span>);</span><br><span class="line">&#125;)();</span><br><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">ifErrorFrame</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  assert.ifError(err);</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj1 = &#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="number">1</span> &#125; &#125;;</span><br><span class="line"><span class="keyword">const</span> obj2 = &#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="number">2</span> &#125; &#125;;</span><br><span class="line"><span class="keyword">const</span> obj3 = &#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="number">1</span> &#125; &#125;;</span><br><span class="line"><span class="keyword">const</span> obj4 = <span class="built_in">Object</span>.create(obj1);</span><br><span class="line">assert.notDeepEqual(obj1, obj1);</span><br><span class="line">assert.notDeepEqual(obj1, obj2);</span><br><span class="line">assert.notDeepEqual(obj1, obj3);</span><br><span class="line">assert.notDeepEqual(obj1, obj4);</span><br><span class="line"></span><br><span class="line">assert.notDeepStrictEqual(&#123; <span class="attr">a</span>: <span class="number">1</span> &#125;, &#123; <span class="attr">a</span>: <span class="string">'1'</span> &#125;);</span><br><span class="line"></span><br><span class="line">assert.notEqual(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">assert.notEqual(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">assert.notEqual(<span class="number">1</span>, <span class="string">'1'</span>);</span><br><span class="line"></span><br><span class="line">assert.notStrictEqual(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">assert.notStrictEqual(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">assert.notStrictEqual(<span class="number">1</span>, <span class="string">'1'</span>);</span><br><span class="line"></span><br><span class="line">assert.ok(<span class="literal">true</span>);</span><br><span class="line">assert.ok(<span class="number">1</span>);</span><br><span class="line">assert.ok();</span><br><span class="line">assert.ok(<span class="literal">false</span>, <span class="string">'it\'s false'</span>);</span><br><span class="line">assert.ok(<span class="keyword">typeof</span> <span class="number">123</span> === <span class="string">'string'</span>);</span><br><span class="line">assert.ok(<span class="keyword">typeof</span> <span class="number">123</span> === <span class="string">'string'</span>);</span><br><span class="line">assert.ok(<span class="literal">false</span>);</span><br><span class="line">assert.ok(<span class="number">0</span>);</span><br><span class="line">assert(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> assert.rejects(</span><br><span class="line">    <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Wrong value'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'TypeError'</span>,</span><br><span class="line">      message: <span class="string">'Wrong value'</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">assert.rejects(</span><br><span class="line">  <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Wrong value'</span>)),</span><br><span class="line">  <span class="built_in">Error</span></span><br><span class="line">).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">assert.strictEqual(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">assert.strictEqual(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">assert.strictEqual(<span class="string">'Hello foobar'</span>, <span class="string">'Hello World!'</span>);</span><br><span class="line"><span class="keyword">const</span> apples = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> oranges = <span class="number">2</span>;</span><br><span class="line">assert.strictEqual(apples, oranges, <span class="string">`apples <span class="subst">$&#123;apples&#125;</span> !== oranges <span class="subst">$&#123;oranges&#125;</span>`</span>);</span><br><span class="line">assert.strictEqual(<span class="number">1</span>, <span class="string">'1'</span>, <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Inputs are not identical'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> err = <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Wrong value'</span>);</span><br><span class="line">err.code = <span class="number">404</span>;</span><br><span class="line">err.foo = <span class="string">'bar'</span>;</span><br><span class="line">err.info = &#123; <span class="attr">nested</span>: <span class="literal">true</span>, <span class="attr">baz</span>: <span class="string">'text'</span> &#125;;</span><br><span class="line">err.reg = <span class="regexp">/abc/i</span>;</span><br><span class="line">assert.throws(</span><br><span class="line">  () =&gt; &#123; <span class="keyword">throw</span> err; &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'TypeError'</span>, <span class="attr">message</span>: <span class="string">'Wrong value'</span>, <span class="attr">info</span>: &#123; <span class="attr">nested</span>: <span class="literal">true</span>, <span class="attr">baz</span>: <span class="string">'text'</span> &#125; &#125;</span><br><span class="line">);</span><br><span class="line">assert.throws(</span><br><span class="line">  () =&gt; &#123; <span class="keyword">throw</span> err; &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="regexp">/^TypeError$/</span>, <span class="attr">message</span>: <span class="regexp">/Wrong/</span>, <span class="attr">foo</span>: <span class="string">'bar'</span>, <span class="attr">info</span>: &#123; <span class="attr">nested</span>: <span class="literal">true</span>, <span class="attr">baz</span>: <span class="string">'text'</span> &#125;, <span class="attr">reg</span>: <span class="regexp">/abc/i</span> &#125;</span><br><span class="line">);</span><br><span class="line">assert.throws(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> otherErr = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not found'</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [key, value] <span class="keyword">of</span> <span class="built_in">Object</span>.entries(err)) &#123;</span><br><span class="line">      otherErr[key] = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> otherErr;</span><br><span class="line">  &#125;,</span><br><span class="line">  err</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">assert.throws(</span><br><span class="line">  () =&gt; &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Wrong value'</span>); &#125;,</span><br><span class="line">  <span class="built_in">Error</span></span><br><span class="line">);</span><br><span class="line">assert.throws(</span><br><span class="line">  () =&gt; &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Wrong value'</span>); &#125;,</span><br><span class="line">  /^<span class="built_in">Error</span>: Wrong value$/</span><br><span class="line">);</span><br><span class="line">assert.throws(</span><br><span class="line">  () =&gt; &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Wrong value'</span>); &#125;,</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    assert(err <span class="keyword">instanceof</span> <span class="built_in">Error</span>);</span><br><span class="line">    assert(<span class="regexp">/value/</span>.test(err));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">'unexpected error'</span></span><br><span class="line">);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throwingFirst</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'First'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throwingSecond</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Second'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notThrowing</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">assert.throws(throwingFirst, <span class="string">'Second'</span>);</span><br><span class="line">assert.throws(throwingSecond, <span class="string">'Second'</span>);</span><br><span class="line">assert.throws(notThrowing, <span class="string">'Second'</span>);</span><br><span class="line">assert.throws(throwingSecond, /Second$/);</span><br><span class="line">assert.throws(throwingFirst, /Second$/);</span><br></pre></td></tr></table></figure>

<h2 id="13-async-hooks"><a href="#13-async-hooks" class="headerlink" title="13. async_hooks"></a>13. async_hooks</h2><p>async_hooks模块提供了一个API，用于注册回调，以跟踪在Node.js应用程序内部创建的异步资源的寿命</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> async_hooks = <span class="built_in">require</span>(<span class="string">'async_hooks'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> eid = async_hooks.executionAsyncId();</span><br><span class="line"><span class="keyword">const</span> tid = async_hooks.triggerAsyncId();</span><br><span class="line"><span class="keyword">const</span> asyncHook = async_hooks.createHook(&#123; init, before, after, destroy, promiseResolve &#125;);</span><br><span class="line">asyncHook.enable();</span><br><span class="line">asyncHook.disable();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">asyncId, type, triggerAsyncId, resource</span>) </span>&#123; &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">before</span>(<span class="params">asyncId</span>) </span>&#123; &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">after</span>(<span class="params">asyncId</span>) </span>&#123; &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">destroy</span>(<span class="params">asyncId</span>) </span>&#123; &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">promiseResolve</span>(<span class="params">asyncId</span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> asyncHook = async_hooks.createHook(&#123;</span><br><span class="line">  init(asyncId, type, triggerAsyncId, resource) &#123; &#125;,</span><br><span class="line">  destroy(asyncId) &#123; &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAsyncCallbacks</span> </span>&#123;</span><br><span class="line">  init(asyncId, type, triggerAsyncId, resource) &#123; &#125;</span><br><span class="line">  destroy(asyncId) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAddedCallbacks</span> <span class="keyword">extends</span> <span class="title">MyAsyncCallbacks</span> </span>&#123;</span><br><span class="line">  before(asyncId) &#123; &#125;</span><br><span class="line">  after(asyncId) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> asyncHook = async_hooks.createHook(<span class="keyword">new</span> MyAddedCallbacks());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debug</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  fs.writeFileSync(<span class="string">'log.out'</span>, <span class="string">`<span class="subst">$&#123;util.format(...args)&#125;</span>\n`</span>, &#123; <span class="attr">flag</span>: <span class="string">'a'</span> &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hook = async_hooks.createHook(callbacks).enable();</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'net'</span>).createServer().listen(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">this</span>.close(); &#125;);</span><br><span class="line"><span class="comment">// OR</span></span><br><span class="line">clearTimeout(setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">async_hooks.createHook(&#123;</span><br><span class="line">  init(asyncId, type, triggerAsyncId) &#123;</span><br><span class="line">    <span class="keyword">const</span> eid = async_hooks.executionAsyncId();</span><br><span class="line">    fs.writeSync(</span><br><span class="line">      <span class="number">1</span>, <span class="string">`<span class="subst">$&#123;type&#125;</span>(<span class="subst">$&#123;asyncId&#125;</span>): trigger: <span class="subst">$&#123;triggerAsyncId&#125;</span> execution: <span class="subst">$&#123;eid&#125;</span>\n`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).enable();</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'net'</span>).createServer(<span class="function">(<span class="params">conn</span>) =&gt;</span> &#123;&#125;).listen(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> indent = <span class="number">0</span>;</span><br><span class="line">async_hooks.createHook(&#123;</span><br><span class="line">  init(asyncId, type, triggerAsyncId) &#123;</span><br><span class="line">    <span class="keyword">const</span> eid = async_hooks.executionAsyncId();</span><br><span class="line">    <span class="keyword">const</span> indentStr = <span class="string">' '</span>.repeat(indent);</span><br><span class="line">    fs.writeSync(</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;indentStr&#125;</span><span class="subst">$&#123;type&#125;</span>(<span class="subst">$&#123;asyncId&#125;</span>):`</span> +</span><br><span class="line">      <span class="string">` trigger: <span class="subst">$&#123;triggerAsyncId&#125;</span> execution: <span class="subst">$&#123;eid&#125;</span>\n`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  before(asyncId) &#123;</span><br><span class="line">    <span class="keyword">const</span> indentStr = <span class="string">' '</span>.repeat(indent);</span><br><span class="line">    fs.writeFileSync(<span class="string">'log.out'</span>,</span><br><span class="line">                     <span class="string">`<span class="subst">$&#123;indentStr&#125;</span>before:  <span class="subst">$&#123;asyncId&#125;</span>\n`</span>, &#123; <span class="attr">flag</span>: <span class="string">'a'</span> &#125;);</span><br><span class="line">    indent += <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  after(asyncId) &#123;</span><br><span class="line">    indent -= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> indentStr = <span class="string">' '</span>.repeat(indent);</span><br><span class="line">    fs.writeFileSync(<span class="string">'log.out'</span>,</span><br><span class="line">                     <span class="string">`<span class="subst">$&#123;indentStr&#125;</span>after:  <span class="subst">$&#123;asyncId&#125;</span>\n`</span>, &#123; <span class="attr">flag</span>: <span class="string">'a'</span> &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  destroy(asyncId) &#123;</span><br><span class="line">    <span class="keyword">const</span> indentStr = <span class="string">' '</span>.repeat(indent);</span><br><span class="line">    fs.writeFileSync(<span class="string">'log.out'</span>,</span><br><span class="line">                     <span class="string">`<span class="subst">$&#123;indentStr&#125;</span>destroy:  <span class="subst">$&#123;asyncId&#125;</span>\n`</span>, &#123; <span class="attr">flag</span>: <span class="string">'a'</span> &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).enable();</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'net'</span>).createServer(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;).listen(<span class="number">8080</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// Let's wait 10ms before logging the server started.</span></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt;&gt;&gt;'</span>, async_hooks.executionAsyncId());</span><br><span class="line">  &#125;, <span class="number">10</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(async_hooks.executionAsyncId());  <span class="comment">// 1 - bootstrap</span></span><br><span class="line">fs.open(path, <span class="string">'r'</span>, (err, fd) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(async_hooks.executionAsyncId());  <span class="comment">// 6 - open()</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.createServer(<span class="function">(<span class="params">conn</span>) =&gt;</span> &#123;</span><br><span class="line">  async_hooks.executionAsyncId();</span><br><span class="line">&#125;).listen(port, () =&gt; &#123;</span><br><span class="line">  async_hooks.executionAsyncId();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.createServer(<span class="function">(<span class="params">conn</span>) =&gt;</span> &#123;</span><br><span class="line">  async_hooks.triggerAsyncId();</span><br><span class="line">&#125;).listen(port, () =&gt; &#123;</span><br><span class="line">  async_hooks.triggerAsyncId();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ah = <span class="built_in">require</span>(<span class="string">'async_hooks'</span>);</span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">1729</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`eid <span class="subst">$&#123;ah.executionAsyncId()&#125;</span> tid <span class="subst">$&#123;ah.triggerAsyncId()&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line">ah.createHook(&#123; init() &#123;&#125; &#125;).enable(); <span class="comment">// forces PromiseHooks to be enabled.</span></span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">1729</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`eid <span class="subst">$&#123;ah.executionAsyncId()&#125;</span> tid <span class="subst">$&#123;ah.triggerAsyncId()&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; AsyncResource, executionAsyncId &#125; = <span class="built_in">require</span>(<span class="string">'async_hooks'</span>);</span><br><span class="line"><span class="keyword">const</span> asyncResource = <span class="keyword">new</span> AsyncResource(</span><br><span class="line">  type, &#123; <span class="attr">triggerAsyncId</span>: executionAsyncId(), <span class="attr">requireManualDestroy</span>: <span class="literal">false</span> &#125;</span><br><span class="line">);</span><br><span class="line">asyncResource.runInAsyncScope(fn, thisArg, ...args);</span><br><span class="line">asyncResource.emitDestroy();</span><br><span class="line">asyncResource.asyncId();</span><br><span class="line">asyncResource.triggerAsyncId();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DBQuery</span> <span class="keyword">extends</span> <span class="title">AsyncResource</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(db) &#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">'DBQuery'</span>);</span><br><span class="line">    <span class="keyword">this</span>.db = db;</span><br><span class="line">  &#125;</span><br><span class="line">  getInfo(query, callback) &#123;</span><br><span class="line">    <span class="keyword">this</span>.db.get(query, (err, data) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.runInAsyncScope(callback, <span class="literal">null</span>, err, data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  close() &#123;</span><br><span class="line">    <span class="keyword">this</span>.db = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.emitDestroy();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/29/docker/" rel="prev" title="docker">
      <i class="fa fa-chevron-left"></i> docker
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/12/29/npm/" rel="next" title="npm">
      npm <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

    <div id="gitmentContainer"></div>
  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-知识点"><span class="nav-number">1.</span> <span class="nav-text">1. 知识点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-内置变量"><span class="nav-number">2.</span> <span class="nav-text">2. 内置变量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-内置方法-函数"><span class="nav-number">3.</span> <span class="nav-text">3. 内置方法&#x2F;函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-setTimeout、clearTimeout"><span class="nav-number">3.1.</span> <span class="nav-text">1. setTimeout、clearTimeout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-setImmediate、clearImmediate"><span class="nav-number">3.2.</span> <span class="nav-text">2. setImmediate、clearImmediate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-setInterval、clearInterval"><span class="nav-number">3.3.</span> <span class="nav-text">3. setInterval、clearInterval</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Buffer"><span class="nav-number">3.4.</span> <span class="nav-text">4. Buffer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-queueMicrotask"><span class="nav-number">3.5.</span> <span class="nav-text">5. queueMicrotask</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-require"><span class="nav-number">3.6.</span> <span class="nav-text">6. require()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-require-X"><span class="nav-number">3.6.1.</span> <span class="nav-text">6.1. require(X)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-module"><span class="nav-number">3.6.2.</span> <span class="nav-text">6.2. module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-模块实例的-require-方法"><span class="nav-number">3.6.3.</span> <span class="nav-text">6.3. 模块实例的 require 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-加载模块"><span class="nav-number">3.6.4.</span> <span class="nav-text">6.4. 加载模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-内置模块及常用方法"><span class="nav-number">4.</span> <span class="nav-text">4. 内置模块及常用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-util"><span class="nav-number">4.1.</span> <span class="nav-text">1. util</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-dns"><span class="nav-number">4.2.</span> <span class="nav-text">3. dns</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-http"><span class="nav-number">4.3.</span> <span class="nav-text">4. http</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-crypto"><span class="nav-number">4.4.</span> <span class="nav-text">5. crypto</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-fs"><span class="nav-number">4.5.</span> <span class="nav-text">6. fs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-zlib"><span class="nav-number">4.6.</span> <span class="nav-text">7. zlib</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-child-process"><span class="nav-number">4.7.</span> <span class="nav-text">8. child_process</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-net"><span class="nav-number">4.8.</span> <span class="nav-text">9. net</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-stream"><span class="nav-number">4.9.</span> <span class="nav-text">10. stream</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-assert"><span class="nav-number">4.10.</span> <span class="nav-text">12. assert</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-async-hooks"><span class="nav-number">4.11.</span> <span class="nav-text">13. async_hooks</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jinwen</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jinwen</span>
</div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
  // https://imsun.net/posts/gitment-introduction/
  var gitment = new Gitment({
    // id: 'tags/index.html', // 可选。默认为 location.href
    id: location.href,
    owner: 'jinven',
    repo: 'jinven.github.io',
    oauth: {
      client_id: 'c632308a327582f31107',
      client_secret: '06592fcf5ed4c08e218fbf0c6ebe2dce1241d054',
    },
  })
  if(document.getElementById('gitmentContainer')){
    gitment.render('gitmentContainer')
  }
</script>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
















  

  

</body>
</html>
